---
interface AdPlaceholderProps {
  calledFrom: string;
  slot: string;
  layout?: string;
  format?: string;
  display?: string;
  textAlign?: string;
  width?: number | string;
  height?: number | string;
  position?: "inline" | "sidebar";
}

const {
  calledFrom,
  slot,
  layout,
  format,
  display = "block",
  textAlign = "center",
  width,
  height,
  position = "inline",
} = Astro.props as AdPlaceholderProps;

// Environment detection (safe on server)
const host = Astro.request?.url
  ? new URL(Astro.request.url).hostname
  : "localhost";

const isLocal =
  host === "localhost" || host === "127.0.0.1" || host.startsWith("192.168.");
const isTest = isLocal ? "on" : "off";
const background = isLocal ? "#dbd6d6ff" : "";

// Default dimensions
const defaultWidth = position === "sidebar" ? 300 : "100%";
const defaultHeight = position === "sidebar" ? 600 : 250;
const containerStyle = `
  display:flex;
  justify-content:${textAlign};
  width:${
    typeof (width ?? defaultWidth) === "number"
      ? `${width ?? defaultWidth}px`
      : (width ?? defaultWidth)
  };
  min-width:250px;
  min-height:${
    typeof (height ?? defaultHeight) === "number"
      ? `${height ?? defaultHeight}px`
      : (height ?? defaultHeight)
  };
  overflow:hidden;
  background:${background};
  margin:1rem 0;
`;

const insStyle = `
  display:${display};
  width:100%;
  height:100%;
`;
---
{!isLocal ? (
  <>
    <div style={containerStyle}>
      <ins
        class="adsbygoogle"
        style={insStyle}
        data-ad-client="ca-pub-4100521225351324"
        data-ad-slot={slot}
        data-full-width-responsive={position === "inline" ? "true" : "false"}
        {...layout ? { "data-ad-layout": layout } : {}}
        {...format ? { "data-ad-format": format } : {}}
      ></ins>
    </div>

    <script is:inline>
      (function () {
        if (typeof window === "undefined") return;

        window.adsbygoogle = window.adsbygoogle || [];

        const ins =
          document.currentScript?.previousElementSibling?.querySelector(
            ".adsbygoogle"
          );

        if (!ins || ins.dataset.pushed) return;

        let attempts = 0;
        const MAX_ATTEMPTS = 20;

        const tryPush = () => {
          const width = ins.offsetWidth;

          if (width > 0) {
            try {
              window.adsbygoogle.push({});
              ins.dataset.pushed = "true";
            } catch (e) {
              console.warn("[AdPlaceholder] AdSense push error:", e);
            }
            return;
          }

          if (attempts < MAX_ATTEMPTS) {
            attempts++;
            requestAnimationFrame(tryPush);
          }
        };

        if (document.readyState === "complete") {
          tryPush();
        } else {
          window.addEventListener("load", tryPush, { once: true });
        }
      })();
    </script>
  </>
) : (
  /* LOCAL DEV PLACEHOLDER (SAFE) */
  <div
    style={`
      ${containerStyle}
      align-items:center;
      justify-content:center;
      color:#555;
      font-size:14px;
      font-weight:600;
      border:1px dashed #aaa;
    `}
  >
    Ad Placeholder ({position})
  </div>
)}
