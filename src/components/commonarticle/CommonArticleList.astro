---
import {
    apiCalls,
    buildLangUrl,
    detectDevice,
    generateBreadcrumb,
    generateItemList,
} from "@lib/postmethodService";
import { EndPointPaths } from "@lib/EndPointPaths";
import { RequestModel } from "@lib/pojo/requestmodel/RequestModel";
import { ArticleResponse } from "@lib/pojo/responsemodel/ArticleResponse";
import Layout from "@layouts/Layout.astro";
import SEO from "@components/SEO.astro";
import { metaConfig } from "@components/metaConfig";
import { getAppConfig } from "@lib/AppConfig";
import { getLangPrefix } from "@lib/postmethodService";
import type { ApiResponse } from "@lib/pojo/responsemodel/ApiResponse";
import type { ResponseModel } from "@lib/pojo/responsemodel/ResponseModel";
import { Image } from "astro:assets";
import AdPlaceholder from "@components/AdPlaceholder.astro";
import { generateSeo } from "@lib/MetaDescriptionUtil";
import type { MetaObject } from "@lib/MetaObject";
const { lang } = Astro.props;
const pageParam = Astro.url.searchParams.get("page");
const currentPage = pageParam ? parseInt(pageParam, 10) : 1;
const limit = 10;
const offset = (currentPage - 1) * limit;
const articleCache: Map<string, ArticleResponse[]> = new Map();
async function getArticle(
    language: string,
    offset: number,
): Promise<ArticleResponse[] | null> {
    const request = new RequestModel();
    request.lang = language;
    request.limit = limit;
    request.offset = offset;
    try {
        const response: ApiResponse = await apiCalls(
            request,
            EndPointPaths.getlatestarticle,
        );
        if (response.status !== 0) return null;
        const resp: ResponseModel = response.data;
        return resp.statusCode === 0 ? resp.respList : null;
    } catch (error) {
        console.error("Error fetching categories:", error);
        return null;
    }
}

const articles: Array<ArticleResponse> = await getArticle(lang, offset);

const langPrefix = await getLangPrefix(lang);
const apiServer = await getAppConfig();
const baseUrl = await buildLangUrl(lang);
const canonicalUrl =
    currentPage === 1
        ? `${baseUrl}article`
        : `${baseUrl}article?page=${currentPage}`;
const siteName = metaConfig.siteName[lang];
const isPageOne = currentPage === 1;

const pageLabel =
  lang === "ar"
    ? `الصفحة ${currentPage}`
    : `Page ${currentPage}`;

const title = isPageOne
  ? lang === "ar"
      ? "مقالات حديثة عن الثقافة والرياضة والأخبار | Quronfula"
      : "Latest Articles on Culture, Sports & News | Quronfula"
  : lang === "ar"
      ? `مقالات حديثة عن الثقافة والرياضة والأخبار – ${pageLabel} | Quronfula`
      : `Latest Articles on Culture, Sports & News – ${pageLabel} | Quronfula`;

const description = isPageOne
  ? lang === "ar"
      ? "تصفح أحدث المقالات عن الثقافة والرياضة والأخبار في كورونفولا. مجموعة مختارة من القصص المتعمقة والرؤى الحديثة يتم تحديثها باستمرار."
      : "Explore the latest articles on culture, sports, and news at Quronfula. A curated collection of in-depth stories and fresh insights, updated regularly."
  : lang === "ar"
      ? `اكتشف المزيد من المقالات عن الثقافة والرياضة والأخبار في كورونفولا. تابع التصفح في ${pageLabel}.`
      : `Discover more articles on culture, sports, and news at Quronfula. Continue browsing ${pageLabel}.`;

    const jsonLd = [];

const itemListJson = generateItemList({
    name: title,
    description: description,
    baseUrl: canonicalUrl,
    listUrl: canonicalUrl,
    items: articles.map((a) => ({
        title: a.title,
        slug: a.slug,
        image: a.landScapeBanner,
        authorName: a.authorName,
        authorSlug: a.authorSlug,
        type: "Article",
    })),
    creatorName: siteName,
    creatorUrl: apiServer.websiteUrl,
});

const breadCrumb = generateBreadcrumb("Home Page Breadcrumbs", [
    {
        name: lang === "ar" ? "الرئيسية" : "Home",
        url: baseUrl,
    },
    {
        name: lang === "ar" ? "مقالات" : "Article",
        url: baseUrl + "article/",
    },
]);

jsonLd.push(breadCrumb);
jsonLd.push(itemListJson);


const ua = Astro.request.headers.get("user-agent");
const device = detectDevice(ua);
const language: any = lang;
let metaObj: MetaObject = generateSeo(
    title,
    description,
    language,
    device,
);
---

<SEO
    title={metaObj.title}
    description={metaObj.metaDesc}
    image={baseUrl + "articleog.webp"}
    url={canonicalUrl}
    lang={lang}
    canonical={canonicalUrl}
    noindex={false}
    type={"CollectionPage"}
    jsonLd={jsonLd}
/>
<Layout>
    <main>
        <section>
			 <div id="container-7538bd9c37b3bc6235c127a4b18d2e6c"></div>
		</section>
        <section>
            <h1>
                {
                    lang === "ar"
                        ? "مقالات جديدة عن الثقافة والرياضة والأخبار"
                        : "Latest Articles on Culture, Sports & News"
                }
            </h1>

            <!-- Wrapper must exist for JS -->
            <section class="articles-grid">
                {
                    articles?.length ? (
                        articles.map((item) => (
                            <article class="article-card">
                                <a
                                    href={`/${langPrefix}article/${item.slug}`}
                                    class="card-link"
                                >
                                    <div class="card-image">
                                        <Image
                                            src={item.landScapeBanner}
                                            alt={item.imageAlt || item.title}
                                            loading="lazy"
                                            width="400"
                                            height="225"
                                        />
                                    </div>
                                    <div class="card-content">
                                        <p class="section-title">
                                            {item.title}
                                        </p>
                                    </div>
                                </a>
                            </article>
                        ))
                    ) : (
                        <p class="no-articles">
                            {lang === "ar"
                                ? "لا توجد مقالات."
                                : "No articles available."}
                        </p>
                    )
                }
            </section>
            <section>
                <AdPlaceholder
                    calledFrom="articleList"
                    slot="2578599202"
                    layout="display"
                    format="auto"
                    display="block"
                    textAlign="center"
                    height={200}
                    width="100%"
                />
            </section>
            <nav class="pagination">
                {
                    currentPage > 1 && (
                        <a
                            href={`/${langPrefix}article?page=${currentPage - 1}`}
                            rel="prev"
                            class="pagination-btn"
                        >
                            ← {lang === "ar" ? "السابق" : "Previous"}
                        </a>
                    )
                }

                <span class="page-number">
                    {
                        lang === "ar"
                            ? `صفحة ${currentPage}`
                            : `Page ${currentPage}`
                    }
                </span>

                {
                    articles.length === limit && (
                        <a
                            href={`/${langPrefix}article?page=${currentPage + 1}`}
                            rel="next"
                            class="pagination-btn"
                        >
                            {lang === "ar" ? "التالي" : "Next"} →
                        </a>
                    )
                }
            </nav>
        </section>

        <style>
           /* ================================
       Pagination
    ================================ */
            .pagination {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 1.5rem;
                margin: 3rem 0;
            }

            .pagination-btn {
                padding: 0.6rem 1.4rem;
                border-radius: 9999px;
                text-decoration: none;
                font-weight: 600;
                border: 1px solid;
            }

            .page-number {
                font-weight: 700;
            }
            .section-title {
                font-size: 1.5rem;
                font-weight: 600;
            }
            .articles-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 20px;
                padding: 16px;
            }

            .article-card {
                background: #fff;
                border-radius: 12px;
                overflow: hidden;
                box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
                transition:
                    transform 0.3s ease,
                    box-shadow 0.3s ease;
            }

            .article-card:hover {
                transform: translateY(-6px);
                box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
            }

            .card-link {
                display: block;
                color: inherit;
                text-decoration: none;
            }

            .card-image {
                overflow: hidden;
                height: 0;
                padding-top: 56.25%; /* 16:9 aspect ratio */
                position: relative;
            }

            .card-image img {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                object-fit: cover;
                transition: transform 0.5s ease;
            }

            .article-card:hover .card-image img {
                transform: scale(1.05);
            }

            .card-content {
                padding: 12px 16px;
            }

            .card-content h2 {
                font-size: 18px;
                margin: 0 0 8px;
                line-height: 1.3;
            }

            .card-content p {
                font-size: 14px;
                color: #555;
                margin: 0;
            }

            .no-articles {
                text-align: center;
                font-size: 16px;
                padding: 20px;
                color: #777;
            }

            /* RTL support */
            html[lang="ar"] .card-content h2,
            html[lang="ar"] .card-content p {
                text-align: right;
            }
        </style>
    </main>
</Layout>
