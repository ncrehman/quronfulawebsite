---
import {
    apiCalls,
    buildLangUrl,
    generateBreadcrumb,
    generateItemList,
} from "@lib/postmethodService";
import { EndPointPaths } from "@lib/EndPointPaths";
import { RequestModel } from "@lib/pojo/requestmodel/RequestModel";
import { ArticleResponse } from "@lib/pojo/responsemodel/ArticleResponse";
import Layout from "@layouts/Layout.astro";
import SEO from "@components/SEO.astro";
import { metaConfig } from "@components/metaConfig";
import { getAppConfig } from "@lib/AppConfig";
import { getLangPrefix } from "@lib/postmethodService";
import type { ApiResponse } from "@lib/pojo/responsemodel/ApiResponse";
import type { ResponseModel } from "@lib/pojo/responsemodel/ResponseModel";
// const lang = Astro.url.pathname.startsWith("/en") ? "en" : "ar";
const { lang } = Astro.props;
let offset = 0;
// Fetch homepage data or articles specific to home page

const articleCache: Map<string, ArticleResponse[]> = new Map();
async function getArticle(
    language: string,
    offset: number,
): Promise<ArticleResponse[] | null> {
    const request = new RequestModel();
    request.lang = language;
    request.offset = offset;
    request.limit = 18;
    try {
        const response: ApiResponse = await apiCalls(
            request,
            EndPointPaths.getlatestarticle,
        );
        if (response.status !== 0) return null;
        const resp: ResponseModel = response.data;
        return resp.statusCode === 0 ? resp.respList : null;
    } catch (error) {
        console.error("Error fetching categories:", error);
        return null;
    }
}

const articles: Array<ArticleResponse> = await getArticle(lang, offset);

const langPrefix = getLangPrefix(lang);
const apiServer = getAppConfig();
const baseUrl = await buildLangUrl(lang);
const canonicalUrl = baseUrl + "article";
const siteName = metaConfig.siteName[lang];
const title = "Quronfula Article Collection";
const description =
    "Explore our collection of in-depth articles covering culture, trends, lifestyle, creativity, and modern storytelling. Updated regularly with fresh insights";
const jsonLd = [];

const itemListJson = generateItemList({
    name: title,
    description: description,
    baseUrl: baseUrl + "article/",
    listUrl: baseUrl + "article/",
    items: articles.map((a) => ({
        title: a.title,
        slug: a.slug,
        image: a.landScapeBanner,
        authorName: a.authorName,
        authorSlug: a.authorSlug,
        type: "Article",
    })),
    creatorName: siteName,
    creatorUrl: apiServer.websiteUrl,
});

const breadCrumb = generateBreadcrumb("Home Page Breadcrumbs", [
    {
        name: lang === "ar" ? "الرئيسية" : "Home",
        url: baseUrl,
    },
    {
        name: lang === "ar" ? "مقالات" : "Article",
        url: baseUrl + "article/",
    },
]);

jsonLd.push(breadCrumb);
jsonLd.push(itemListJson);
---

<SEO
    title={title}
    description={description}
    image={baseUrl + "articleog.webp"}
    url={canonicalUrl}
    lang={lang}
    canonical={canonicalUrl}
    noindex={false}
    type={"WebSite"}
    jsonLd={jsonLd}
/>
<Layout>
    <main>
        <template id="article-card-template">
            <article class="article-card">
                <a href="" class="card-link">
                    <div class="card-image">
                        <img
                            src=""
                            alt=""
                            loading="lazy"
                            width="400"
                            height="225"
                        />
                    </div>
                    <div class="card-content">
                        <p class="section-title"></p>
                       
                    </div>
                </a>
            </article>
        </template>

        <section>
            <h1>
                {
                    lang === "ar"
                        ? "مقالات جديدة عن الثقافة والرياضة والأخبار"
                        : "Latest Articles on Culture, Sports & News"
                }
            </h1>

            <!-- Wrapper must exist for JS -->
            <section class="articles-grid">
                {
                    articles?.length ? (
                        articles.map((item) => (
                            <article class="article-card">
                                <a
                                    href={`/${langPrefix}article/${item.slug}`}
                                    class="card-link"
                                >
                                    <div class="card-image">
                                        <img
                                            src={item.landScapeBanner}
                                            alt={item.imageAlt || item.title}
                                            loading="lazy"
                                            width="400"
                                            height="225"
                                        />
                                    </div>
                                    <div class="card-content">
                                        <p class="section-title">{item.title}</p>
                                    </div>
                                </a>
                            </article>
                        ))
                    ) : (
                        <p class="no-articles">
                            {lang === "ar"
                                ? "لا توجد مقالات."
                                : "No articles available."}
                        </p>
                    )
                }
                <div id="trigger"></div>
            </section>
        </section>

        <style>
            #trigger {
                width: 100%;
                height: 1px;
                grid-column: 1 / -1; /* span full width */
                visibility: hidden; /* invisible but still detectable */
            }
            .section-title {
                font-size: 1.5rem;
                font-weight: 600;
            }
            .articles-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 20px;
                padding: 16px;
            }

            .article-card {
                background: #fff;
                border-radius: 12px;
                overflow: hidden;
                box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
                transition:
                    transform 0.3s ease,
                    box-shadow 0.3s ease;
            }

            .article-card:hover {
                transform: translateY(-6px);
                box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
            }

            .card-link {
                display: block;
                color: inherit;
                text-decoration: none;
            }

            .card-image {
                overflow: hidden;
                height: 0;
                padding-top: 56.25%; /* 16:9 aspect ratio */
                position: relative;
            }

            .card-image img {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                object-fit: cover;
                transition: transform 0.5s ease;
            }

            .article-card:hover .card-image img {
                transform: scale(1.05);
            }

            .card-content {
                padding: 12px 16px;
            }

            .card-content h2 {
                font-size: 18px;
                margin: 0 0 8px;
                line-height: 1.3;
            }

            .card-content p {
                font-size: 14px;
                color: #555;
                margin: 0;
            }

            .no-articles {
                text-align: center;
                font-size: 16px;
                padding: 20px;
                color: #777;
            }

            /* RTL support */
            html[lang="ar"] .card-content h2,
            html[lang="ar"] .card-content p {
                text-align: right;
            }
        </style>
    </main>
</Layout>
<template id="article-card-template">
    <article class="article-card">
        <a class="card-link">
            <div class="card-image">
                <img loading="lazy" width="400" height="225" />
            </div>
            <div class="card-content">
              <p class="section-title"></p>
            </div>
        </a>
    </article>
</template>
<script define:vars={{ lang, langPrefix }}>
    if (typeof window !== "undefined") {
        let page = 1;
        let loading = false;

        const grid = document.querySelector(".articles-grid");
        const trigger = document.getElementById("trigger");
        const template = document.getElementById("article-card-template");

        // Safety check
        if (!grid || !trigger || !template) {
            console.error("Required elements missing");
            return;
        }

        const observer = new IntersectionObserver(async ([entry]) => {
            if (!entry.isIntersecting || loading) return;
            loading = true;

            const res = await fetch(
                `/api/articlesapi?lang=${lang}&page=${page}`,
            );
            const contentList = await res.json();

            if (!contentList.length) {
                return;
            }

            contentList.forEach((item) => {
                const clone = template.content.cloneNode(true);

                const link = clone.querySelector(".card-link");
                const img = clone.querySelector("img");
                const title = clone.querySelector("h2");

                link.href = `/${langPrefix}article/${item.slug}`;
                img.src = item.landScapeBanner;
                img.alt = item.imageAlt || item.title;
                title.textContent = item.title;
                grid.insertBefore(clone, trigger);
                // grid.appendChild(clone);
                // grid.appendChild(trigger);
            });

            page += 1;
            loading = false;
        });

        observer.observe(trigger);
    }
</script>
