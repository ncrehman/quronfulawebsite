---
import { metaConfig } from "@components/metaConfig";
import SEO from "@components/SEO.astro";
import Layout from "@layouts/Layout.astro";
import { getAppConfig } from "@lib/AppConfig";
import { EndPointPaths } from "@lib/EndPointPaths";
import { RequestModel } from "@lib/pojo/requestmodel/RequestModel";
import { ApiResponse } from "@lib/pojo/responsemodel/ApiResponse";
import { ArticleResponse } from "@lib/pojo/responsemodel/ArticleResponse";
import type { FeedContentResponse } from "@lib/pojo/responsemodel/FeedContentResponse";
import type { ResponseModel } from "@lib/pojo/responsemodel/ResponseModel";
import { cleanHtmlString, getLangPrefix } from "@lib/postmethodService";

import {
    apiCalls,
    checkForDecode,
    generateBreadcrumb,
    getLocalizedAmpUrl,
    generateFAQJsonLd,
    buildLangUrl,
} from "@lib/postmethodService";

interface Props {
    slug: string;
    lang: string;
}

const { slug = "", lang = "ar" } = Astro.props;
// Props passed from getStaticPaths/getStaticProps

const articleCache: Map<string, FeedContentResponse> = new Map();

async function getArticles(
    language: string,
    articleSlug: string,
): Promise<FeedContentResponse | null> {
    const cacheKey = `${language}_home_${"article"}`;
    if (articleCache.has(cacheKey)) {
        return articleCache.get(cacheKey)!;
    }
    const request = new RequestModel();
    request.lang = lang;
    request.slug = articleSlug;
    const responseResult: ApiResponse = await apiCalls(
        request,
        EndPointPaths.getarticlebyslug,
    );
    if (responseResult.status !== 0) return null;
    const response: ResponseModel = responseResult.data;
    if (response.statusCode === 0) {
        const article: FeedContentResponse = response.respObject;
        if (article) {
            articleCache.set(cacheKey, article);
        }
        return article;
    } else {
        return null;
    }
}

const langPrefix = getLangPrefix(lang);
const baseUrl = await buildLangUrl(lang);

const decodedSlug = await checkForDecode(slug);
const apiServer = getAppConfig();
const siteName = metaConfig.siteName[lang];

const article: FeedContentResponse = await getArticles(lang, slug);
const canonicalUrl = baseUrl + "article/" + decodedSlug;
const jsonLd = [];

let keywords = [];
if (!!article) {
    keywords = article.keywords?.split(",").map((k) => k.trim()) || [];
    const about = [...new Set(keywords.map((k) => k.trim()))].map(
        (keyword) => ({
            "@type": "Thing",
            name: keyword,
        }),
    );
    const breadCrumb = generateBreadcrumb("Article Page Breadcrumbs", [
        {
            name: siteName,
            url: baseUrl,
        },
        {
            name: "Articles",
            url: baseUrl + "artcile/",
        },
        {
            name: article.title,
            url: baseUrl + "artcile/" + article.slug,
        },
    ]);
    const articleJsonLd = {
        "@context": "https://schema.org",
        "@type": "NewsArticle",
        mainEntityOfPage: {
            "@type": "WebPage",
            "@id": canonicalUrl,
        },
        ...(article.ampUrl && {
            potentialAction: [
                {
                    "@type": "ViewAction",
                    target: getLocalizedAmpUrl(article.ampUrl, lang),
                    name: "View Web Story",
                },
            ],
        }),
        headline: article.title,
        alternativeHeadline: article.metaTitle,
        description: article.metaDescription,
        image: [
            article.landScapeBanner,
            article.bannerImage,
            article.squareBanner,
        ].filter(Boolean),
        author: {
            "@type": "Person",
            name: article.author_name,
            url: baseUrl + "author/" + article.author_slug,
        },
        publisher: {
            "@type": "Organization",
            name: "Quronfula",
            logo: {
                "@type": "ImageObject",
                url: apiServer.websiteUrl + "logo.png",
            },
        },
        keywords: keywords,
        about: about,
        datePublished: article.publishDate,
        dateModified: article.updatedAt || article.publishDate,
    };

    let howToSchema: any = null;
    if (article.howToSchema != null) {
        howToSchema = {
            "@context": "https://schema.org",
            "@type": "HowTo",
            name: article.howToSchema.name,
            description: article.howToSchema.description,
            image: article.landScapeBanner,
            step: article.howToSchema.step.map((s) => ({
                "@type": "HowToStep",
                name: s.name,
                text: s.text,
            })),
        };
    } else {
        howToSchema = null;
    }
    let faqSchema: any = null;
    if (article.faqSchema != null) {
        faqSchema = generateFAQJsonLd(article.faqSchema);
    } else {
        faqSchema = null;
    }

    jsonLd.push(articleJsonLd);
    jsonLd.push(breadCrumb);

    if (faqSchema) jsonLd.push(faqSchema);
    if (howToSchema) jsonLd.push(howToSchema);
}

const cleanHtml = cleanHtmlString(article.description);
const hasAmp =
    typeof article?.ampUrl === "string" && article.ampUrl.trim() !== "";
const ampUrl = hasAmp ? getLocalizedAmpUrl(article.ampUrl, lang) : null;
---

{
    article && (
        <SEO
            title={article.title}
            description={article.metaDescription}
            image={article.landScapeBanner}
            url={canonicalUrl}
            lang={lang}
            canonical={canonicalUrl}
            noindex={false}
            type="article"
            jsonLd={jsonLd}
            media={{
                amphtml: ampUrl,
            }}
        />
    )
}
<Layout>
    <div class="article-grid">
        <!-- LEFT AD COLUMN -->
        <aside class="ad-left">
            <slot name="left-ad" />
        </aside>

        <!-- CENTER ARTICLE -->
        <main class="article-wrapper">
            <h1 class="title">{article.title}</h1>

            {article.subTitle && <h2 class="subtitle">{article.subTitle}</h2>}

            <div class="meta">
                <span
                    >{
                        new Date(article.publishDate).toLocaleDateString(lang)
                    }</span
                >
            </div>

            {
                article.landScapeBanner && (
                    <figure class="hero-figure">
                        <div class="hero-image-wrapper">
                            <img
                                src={article.landScapeBanner}
                                alt={article.imageAlt}
                                width={1200}
                                height={630}
                                loading="eager"
                                fetchpriority="high"
                                class="hero-image"
                            />
                        </div>
                        {article.caption && (
                            <figcaption class="hero-caption">
                                {article.caption}
                            </figcaption>
                        )}
                    </figure>
                )
            }

            <article class="article-content" set:html={cleanHtml} />

            <div class="share-box">
                <span>Share:</span>
                <a
                    href={`https://facebook.com/sharer/sharer.php?u=${canonicalUrl}`}
                    >FB</a
                >
                <a href={`https://x.com/share?url=${canonicalUrl}`}>X</a>
            </div>
        </main>

        <!-- RIGHT AD COLUMN -->
        <aside class="ad-right">
            <slot name="right-ad" />
        </aside>
    </div>
</Layout>
<style is:global>
    /* ================================
   GRID LAYOUT
================================ */
.hero-image-wrapper {
  width: 100%;
  aspect-ratio: 1200 / 630; /* Maintains 1.91:1 ratio */
  overflow: hidden;
  border-radius: 8px; /* optional */
}

.hero-image-wrapper img.hero-image {
  width: 100%;
  height: 100%;
  object-fit: cover; /* ensures image fills container without distortion */
  display: block;
}
    .article-grid {
        display: grid;
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    /* Hide ad columns on mobile */
    @media (max-width: 1024px) {
        .article-grid {
            grid-template-columns: 1fr;
        }
    }

    /* ================================
   ARTICLE TYPOGRAPHY
================================ */
    .article-wrapper {
        background: white;
    }

    .title {
        font-size: clamp(26px, 3vw, 36px);
        font-weight: 700;
        margin-bottom: 12px;
        line-height: 1.3;
        color: #111; /* high contrast */
    }

    .subtitle {
        font-size: clamp(18px, 2.2vw, 22px);
        color: #333; /* improved contrast */
        margin-bottom: 14px;
    }

    .meta {
        font-size: 0.9rem;
        color: #444; /* improved contrast */
        margin-bottom: 22px;
    }

    /* ================================
   HERO IMAGE
================================ */
    .hero-image {
        width: 100%;
        border-radius: 8px;
        margin: 20px 0;
    }

    .hero-caption {
        font-size: 0.9rem;
        text-align: center;
        color: #444; /* improved contrast */
        margin-top: 6px;
    }

    /* ================================
   ARTICLE CONTENT
================================ */
    .article-content {
        font-size: clamp(16px, 2vw, 20px);
        line-height: 1.7;
        color: #111; /* high contrast */
        text-align: justify; /* Fallback for LTR */
    }

    .article-content * {
        max-width: 100% !important;
        box-sizing: border-box;
        overflow-wrap: anywhere; /* does NOT break Arabic words */
        word-break: normal;
        hyphens: auto;
    }

    /* Responsive images */
    .article-content img {
        max-width: 100% !important;
        height: auto !important;
        display: block;
        margin: 20px auto;
    }

    /* Responsive tables */
    .article-content table {
        width: 100% !important;
        display: block;
        overflow-x: auto;
        border-collapse: collapse;
    }

    /* Responsive iframes */
    .article-content iframe {
        max-width: 100% !important;
        height: auto;
        aspect-ratio: 16/9;
    }

    /* Headings inside editor HTML */
    .article-content h2,
    .article-content h3,
    .article-content h4 {
        margin-top: 28px;
        margin-bottom: 12px;
        line-height: 1.4;
        color: #111; /* high contrast */
    }

    /* Paragraphs */
    .article-content p {
        margin: 16px 0;
        color: #111; /* high contrast */
    }

    /* Links */
    .article-content a {
        color: #0066cc;
        text-decoration: underline;
    }
    .article-content a {
        min-height: auto;
        padding: 0;
        display: inline;
    }

    /* Lists */
    .article-content ul,
    .article-content ol {
        padding-left: 20px;
        margin: 16px 0;
    }

    /* ================================
   SHARE BOX
================================ */
    .share-box {
        margin-top: 40px;
        font-size: 1rem;
        display: flex;
        gap: 12px;
    }

    /* ================================
   RTL SUPPORT (Arabic)
================================ */
    html[dir="rtl"] .article-content * {
        word-break: keep-all !important;
        overflow-wrap: anywhere;
    }
</style>
