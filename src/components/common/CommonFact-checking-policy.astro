---
import { metaConfig } from "@components/metaConfig";
import SEO from "@components/SEO.astro";
import Layout from "@layouts/Layout.astro";
import { getAppConfig } from "@lib/AppConfig";
import { EndPointPaths } from "@lib/EndPointPaths";
import { generateSeo } from "@lib/MetaDescriptionUtil";
import type { MetaObject } from "@lib/MetaObject";
import { RequestModel } from "@lib/pojo/requestmodel/RequestModel";
import type { ApiResponse } from "@lib/pojo/responsemodel/ApiResponse";
import type { FactCheckingResponse } from "@lib/pojo/responsemodel/FactCheckingResponse";
import type { ResponseModel } from "@lib/pojo/responsemodel/ResponseModel";
import {
    apiCalls,
    buildLangUrl,
    detectDevice,
    generateBreadcrumb,
} from "@lib/postmethodService";

interface Props {
    lang: string;
}
const apiServer = await getAppConfig();

const { lang = apiServer.defaultLanguage } = Astro.props;

const dataCache: Map<string, FactCheckingResponse> = new Map();

async function getData(language: string): Promise<FactCheckingResponse | null> {
    const cacheKey = `${language}_FactChecking`;
    if (dataCache.has(cacheKey)) {
        return dataCache.get(cacheKey)!;
    }
    const request = new RequestModel();
    request.lang = lang;
    request.extraVariable = "FactChecking";
    const responseResult: ApiResponse = await apiCalls(
        request,
        EndPointPaths.getpolicies,
    );
    if (responseResult.status !== 0) return null;
    const response: ResponseModel = responseResult.data;
    if (response.statusCode === 0) {
        const data: FactCheckingResponse = response.respObject;
        if (data) {
            dataCache.set(cacheKey, data);
        }
        return data;
    } else {
        return null;
    }
}
const baseUrl = await buildLangUrl(lang);
const canonicalUrl = baseUrl + "fact-checking-policy";

const siteName = metaConfig.siteName[lang];

const dataObj: FactCheckingResponse = await getData(lang);

if (!dataObj) {
    return new Response("Page data not available", { status: 404 });
}

const jsonLd = [];

const breadCrumb = generateBreadcrumb("FactChecking Page Breadcrumbs", [
    {
        name: siteName,
        url: baseUrl,
    },
    {
        name: dataObj.metaTitle,
        url: canonicalUrl,
    },
]);

const pageJsonLd = {
    "@context": "https://schema.org",
    "@type": "WebPage",
    name: dataObj.metaTitle,
    description: dataObj.metaDescription,
    url: canonicalUrl,
    inLanguage: lang,
    about: "FactChecking",
    publisher: {
        "@type": "Organization",
        name: siteName,
        url: apiServer.websiteUrl,
        logo: {
            "@type": "ImageObject",
            url: apiServer.websiteUrl + "logo.webp",
        },
        email: "contact@quronfula.com",
    },
};

jsonLd.push(pageJsonLd);
jsonLd.push(breadCrumb);
const ua = Astro.request.headers.get("user-agent");
const device = detectDevice(ua);
const language: any = lang;
let metaObj: MetaObject = generateSeo(
    dataObj.metaTitle,
    dataObj.metaDescription,
    language,
    device,
);
---

<SEO
    title={metaObj.title}
    description={metaObj.metaDesc}
    image={dataObj.bannerImage}
    url={canonicalUrl}
    lang={lang}
    canonical={canonicalUrl}
    noindex={false}
    type={"website"}
    jsonLd={jsonLd}
/>

<Layout>
    <section
        class="legal-page container mx-auto px-4 py-12"
    >
        <main class="container max-w-3xl mx-auto">
            <h1 class="text-4xl font-bold mb-8 text-center">
                {dataObj?.metaTitle}
            </h1>
            <div set:html={dataObj?.description} />
        </main>
    </section>
</Layout>
