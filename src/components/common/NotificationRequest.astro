---
// import { messaging, getToken } from "../lib/firebase.js";
---

<script>
    import { EndPointPaths } from "@lib/EndPointPaths";
    import { getToken, messaging } from "@lib/firebase";
    import { RequestModel } from "@lib/pojo/requestmodel/RequestModel";
    import { apiCalls } from "@lib/postmethodService";
    async function checkSubscription(token: string) {
        const today = new Date().toISOString().split("T")[0];
        const lastSubscribedDate = localStorage.getItem("fcmSubscribedDate");
        const cachedToken = localStorage.getItem("quronfulafcmToken");
        if (cachedToken !== token) {
            await sendTokenToServer(token, today);
            localStorage.setItem("quronfulafcmToken", token);
        } else if (lastSubscribedDate !== today) {
            await sendTokenToServer(token, today);
        }
    }

    async function requestPermission() {
        const status = Notification.permission;
        // Already granted
        if (status === "granted") {
            await proceedWithFCM();
            return;
        }

        // Permanently denied → cannot auto ask again
        if (status === "denied") {
            showEnableNotificationUI(); // your custom UI
            return;
        }

        // status === "default"
        const permission = await Notification.requestPermission();

        if (permission !== "granted") {
            return;
        }

        await proceedWithFCM();
    }
    function showEnableNotificationUI() {
        alert(
            "Notifications are disabled. Please enable them from browser settings.",
        );
    }
    async function proceedWithFCM() {
        const registration = await navigator.serviceWorker.register(
            "/firebase-messaging-sw.js",
        );

        const token = await getToken(messaging, {
            vapidKey:
                "BEHGkD-yqE9UDk7IY6PkekjW59wgp8hX9vAJ4_unSjklg3vQGz33PGAvTrAV92TzXmkmCI6UMMsMT1PEGPmZL7c",
            serviceWorkerRegistration: registration,
        });

        if (!token) return;
        checkSubscription(token);
    }

    // ❌ remove auto-execution on page load
    // window.addEventListener("DOMContentLoaded", () => requestPermission());

    // Instead, run permission only once per browser
    window.addEventListener("DOMContentLoaded", () => {
        const needPermission = localStorage.getItem("fcmSetupDone");

        if (needPermission !== "true") {
            // Ask permission only first visit
            requestPermission();
            localStorage.setItem("fcmSetupDone", "true");
        }
    });

    const sendTokenToServer = async (token, date) => {
        try {
            const topic = "Quronfula";
            const request = new RequestModel();
            request.lang = "en";
            request.extraVariable = topic;
            request.authToken = token;
            const response = await apiCalls(
                request,
                EndPointPaths.subscribetotopic,
            );
            if (response.status === 0) {
                const res = response.data;
                if (res.statusCode === 0) {
                    localStorage.setItem("fcmSubscribedDate", date);
                } else {
                    localStorage.removeItem("quronfulafcmToken");
                }
            }
        } catch (err) {
            localStorage.removeItem("quronfulafcmToken");
        }
    };
</script>

<!-- <button onclick="requestPermission()"> Allow Notifications </button> -->
