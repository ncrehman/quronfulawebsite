---
import { WebStoryResponse } from "@lib/pojo/responsemodel/WebStoryResponse";
import { StorySlide } from "@lib/pojo/responsemodel/StorySlide";
import { EndPointPaths } from "@lib/EndPointPaths";
import { RequestModel } from "@lib/pojo/requestmodel/RequestModel";
import { ApiResponse } from "@lib/pojo/responsemodel/ApiResponse";
import { ResponseModel } from "@lib/pojo/responsemodel/ResponseModel";
import { apiCalls, buildLangUrl, getLangPrefix } from "@lib/postmethodService";
import { getAppConfig } from "@lib/AppConfig";

const currentPath = Astro.url.pathname;
const { slug } = Astro.params;
const lang = currentPath.startsWith("/en") ? "en" : "ar";
const langPrefix = getLangPrefix(lang);
const apiServer = getAppConfig();
const baseUrl = await buildLangUrl(lang);
/* Fetch data */
export async function getWebStory(
    lang: string,
    slug: string,
): Promise<WebStoryResponse | null> {
    try {
        const req = new RequestModel();
        req.lang = lang;
        req.slug = slug;

        const result: ApiResponse = await apiCalls(
            req,
            EndPointPaths.getstorybyslug,
        );
        if (result.status === 0) {
            const resp: ResponseModel = result.data;
            if (resp.statusCode === 0) {
                return resp.respObject as WebStoryResponse;
            }
        }
    } catch (e) {
        console.error("WebStory error:", e);
    }
    return null;
}

const story: WebStoryResponse | null = await getWebStory(lang, slug);
if (!story) throw new Error("Story not found");
const animations = [
    "fade-in",
    "fly-in-left",
    "fly-in-right",
    "fly-in-top",
    "fly-in-bottom",
    "whoosh-in-right",
    "pulse",
];
const gradients = [
    ["#f3633fff", "#ef9b5bff"],
    ["#6A11CB", "#2575FC"],
    ["#F7971E", "#FFD200"],
    ["#2ac5a6ff", "#191654"],
    ["#0F2027", "#203A43"],
    ["#2C3E50", "#4CA1AF"],
    ["#4B6CB7", "#182848"],
    ["#FF416C", "#FF4B2B"],
    ["#1D4350", "#A43931"],
    ["#373B44", "#4286f4"],
];

/* Safe attribute escape */
function esc(v: string | undefined) {
    if (!v) return "";
    return v
        .replace(/&/g, "&amp;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
}
function htmlData(story: WebStoryResponse) {
    const firstPage = `
<amp-story-page id="banner-page" auto-advance-after="2s">

  <!-- Background Image -->
  <amp-story-grid-layer template="fill">
    <amp-img 
      src="${story.bannerImage}" 
      layout="fill" 
      alt="${story.title}">
    </amp-img>
  </amp-story-grid-layer>

</amp-story-page>
`;
    const slideHtml = story.slides
        .map((slide, i) => {
            const animation = animations[i % animations.length];
            const delay = (i % 3) * 0.3;

            const [c1, c2] = gradients[i % gradients.length];
            const bgImage = `/api/gradient?c1=${encodeURIComponent(c1)}&c2=${encodeURIComponent(c2)}`;

            return String.raw`
<amp-story-page id="slide-${slide.id ? slide.id : Math.floor(Math.random() * 10000)}"
    auto-advance-after="${Math.max(slide.duration || 0, 5)}s">

  <amp-story-grid-layer template="fill">
    <amp-img
      src="${bgImage}"
      layout="fill"
      object-fit="cover"
      alt="Background image">
    </amp-img>
  </amp-story-grid-layer>

  <amp-story-grid-layer template="vertical" class="heading-layer">
    <div class="heading-container">
      <h3 
        animate-in="fly-in-top"
        animate-in-delay="0.3s"
        animate-in-duration="0.8s">
        ${slide.heading}
      </h3>
    </div>
  </amp-story-grid-layer>

  <amp-story-grid-layer template="vertical" class="center-content">
    <div class="text-container">
      <h2 
        animate-in="${animation}"
        animate-in-delay="${delay}s"
        animate-in-duration="1s">
        ${slide.text}
      </h2>
    </div>
  </amp-story-grid-layer>

  ${
      i === story.slides.length - 1 && story.referenceLink
          ? String.raw`
        <amp-story-page-attachment layout="nodisplay" href="${story.referenceLink}">
           Read Full Article
        </amp-story-page-attachment>
      `
          : ""
  }

</amp-story-page>
`;
        })
        .join("");
    const allPages = firstPage + slideHtml;
    return allPages;
}

const slidesHtml = htmlData(story);

const relatedStoriesHtml = story.relatedStories?.length
    ? `
<div class="block related-stories-container">
  ${story.relatedStories
      .map(
          (rel) => `
      <a class="related-story-block" href="${baseUrl + "stories/" + rel.slug}">
        <amp-img width="138" height="184" layout="responsive" class="img-fill"
                 src="${rel.bannerImage}" alt="${rel.title}">
        </amp-img>
        <span class="related-story-title">${rel.title}</span>
      </a>
  `,
      )
      .join("")}
</div>

${
    story.cta && story.cta.trim() !== ""
        ? `
<div class="cta-section">
  <a href="${apiServer.websiteUrl}stories"
     class="cta-button"
     target="_blank" rel="noopener noreferrer">
     ${story.cta} →
  </a>
</div>
`
        : ""
}
`
    : `
${
    story.cta && story.cta.trim() !== ""
        ? `
<div class="cta-section">
  <a href="${apiServer.websiteUrl}stories"
     class="cta-button"
     target="_blank" rel="noopener noreferrer">
     ${story.cta} →
  </a>
</div>
`
        : ""
}
`;

const [c1, c2] = gradients[5 % gradients.length];
const bgImage = `/api/gradient?c1=${encodeURIComponent(c1)}&c2=${encodeURIComponent(c2)}`;
---

<!doctype html>
<html ⚡ lang={lang} dir={lang === "ar" ? "rtl" : "ltr"}>
    <head>
        <!-- <meta charset="utf-8" /> -->
        <title>{story.metaTitle || story.title}</title>
        <meta
            name="description"
            content={story.metaDescription || story.title}
        />
        <link rel="canonical" href={story.canonicalUrl} />
        <meta
            name="viewport"
            content="width=device-width,minimum-scale=1,initial-scale=1"
        />

        <!-- AMP core + story -->
        <script async src="https://cdn.ampproject.org/v0.js"></script>
        <script
            async
            custom-element="amp-story"
            src="https://cdn.ampproject.org/v0/amp-story-1.0.js"></script>

        <!-- AMP boilerplate -->
        <style amp-boilerplate>
            body {
                animation: -amp-start 8s steps(1, end) 0s 1 normal both;
            }
            @keyframes -amp-start {
                from {
                    visibility: hidden;
                }
                to {
                    visibility: visible;
                }
            }
        </style>
        <noscript
            ><style amp-boilerplate>
                body {
                    animation: none;
                }
            </style></noscript
        >

        <!-- Custom styles -->
        <style amp-custom>
            @font-face {
                font-family: "QFArabic";
                src: url("https://www.quronfula.com/fonts/Almarai-Regular.woff2") format("woff2");
                font-weight: 400;
                font-display: swap;
            }
            @font-face {
                font-family: "QFArabic";
                src: url("https://www.quronfula.com/fonts/Almarai-Bold.woff2") format("woff2");
                font-weight: 700;
                font-display: swap;
            }
            html {
                font-family: sans-serif;
            }
            html[lang="ar"] {
                font-family: "QFArabic", sans-serif;
            }

            .cta-section {
                text-align: center;
                margin-top: 1.5rem;
                padding: 1rem 0;
            }

            .cta-button {
                display: inline-block;
                background: linear-gradient(135deg, #bd686a, #cc4144);
                color: #fff;
                text-decoration: none;
                font-weight: 600;
                font-family: "Merriweather", serif;
                padding: 0.8rem 1.6rem;
                border-radius: 8px;
                transition: 0.3s ease;
            }

            .cta-button:hover {
                background: linear-gradient(135deg, #cc4144, #bd686a);
            }

            .related-title {
                font-size: 22px;
                font-weight: bold;
                color: white;
                display: block;
                margin-bottom: 16px;
                font-family: "Merriweather", serif;
                text-align: center;
            }

            .related-stories-container {
                display: flex;
                flex-wrap: wrap;
                justify-content: space-around;
                gap: 12px;
            }

            .related-story-block {
                width: 45%;
                /* 2 stories per row on mobile */
                text-align: center;
                cursor: pointer;
                text-decoration: none;
                font-family: "Merriweather", serif;
            }

            .related-story-block amp-img {
                border-radius: 8px;
            }

            .related-story-block a {
                text-decoration: none;
            }

            .related-story-title {
                display: block;
                font-size: 14px;
                color: white;
                font-family: "Merriweather", serif;
                margin-top: 4px;
            }

            .banner-title-layer {
                align-content: end;
                /* Push content to bottom of the layer */
                padding: 20px;
                /* Space around the text */
            }

            .banner-title {
                font-size: 32px;
                /* Adjust size as needed */
                font-weight: bold;
                color: white;
                /* Stand out on top of the banner image */
                font-family: "Merriweather", serif;
                text-align: center;
                margin: 0;
                line-height: 1.2;
                text-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);
                /* Improves readability */
            }

            /* Top heading layer */
            .heading-container h1,
            .heading-container h3 {
                font-size: 22px;
                font-weight: bold;
                color: white;
                font-family: "Merriweather", serif;
                text-align: center;
                /* or left */
                margin: 0;
                line-height: 1.2;
            }

            /* Center text layer */
            .center-content {
                align-content: center;
                /* Centers text vertically */
                padding: 20px;
            }

            /* Text style */
            .text-container h2 {
                font-size: 22px;
                color: white;
                text-align: center;
                font-family: "Merriweather", serif;
                margin: 0;
            }

            h1,
            h2,
            h3 {
                font-weight: normal;
            }

            amp-story-page {
                background-color: #131516;
            }

            amp-story-grid-layer {
                overflow: visible;
            }

            @media (max-aspect-ratio: 9 / 16) {
                @media (min-aspect-ratio: 320 / 678) {
                    amp-story-grid-layer.grid-layer {
                        margin-top: calc(
                            (100% / 0.5625 - 100% / 0.6666666666666666) / 2
                        );
                    }
                }
            }

            @media not all and (min-resolution: 0.001dpcm) and (max-width: 600px) {
                p.text-wrapper > span {
                    font-size: calc(100% - 0.5px);
                }
            }
        </style>
    </head>

    <body>
        <!-- <amp-story
            standalone
            title={story.title}
            publisher={story.author_name || "Quronfula"}
            publisher-logo-src={"/logo.webp"}
            poster-portrait-src={story.bannerImage}
            set:html={slidesHtml}
        /> -->
        <amp-story
            standalone
            title="{{storyTitle}}"
            publisher="{{siteName}}"
            publisher-logo-src="https://www.quronfula.com/logo.webp"
            poster-square-src="{{posterSqaure}}"
            poster-portrait-src="{{posterPortrait}}"
            poster-landscape-src="{{posterLandScape}}"
            set:html={slidesHtml}
        >
        
            <!-- {slidesHtml} -->
            <!-- AMP Story Bookend -->

            <amp-story-page id="related-slide" class="slide related-slide">
                <amp-story-grid-layer template="fill">
                    <amp-img
                        src={bgImage}
                        layout="fill"
                        object-fit="cover"
                        alt="Background image"
                    >
                    </amp-img>
                </amp-story-grid-layer>
                <!-- <amp-story-grid-layer
                    template="vertical"
                    id="related-slide-layer"
                >
                    <div class="content-block">
                        <div class="block">
                            <span class="related-title"
                                >View Related Stories</span
                            >
                        </div>

                        {relatedStoriesHtml}
                    </div>
                </amp-story-grid-layer> -->
            </amp-story-page>
        </amp-story>
    </body>
</html>
