---
// src/pages/stories/[slug].astro
import { metaConfig } from "@components/metaConfig";
import { getAppConfig } from "@lib/AppConfig";
import { EndPointPaths } from "@lib/EndPointPaths";
import { RequestModel } from "@lib/pojo/requestmodel/RequestModel";
import type { ApiResponse } from "@lib/pojo/responsemodel/ApiResponse";
import type { ResponseModel } from "@lib/pojo/responsemodel/ResponseModel";
import type { WebStoryResponse } from "@lib/pojo/responsemodel/WebStoryResponse";
import { getLangPrefix, buildLangUrl, apiCalls } from "@lib/postmethodService";

const currentPath = Astro.url.pathname;
const { slug } = Astro.params;
const lang = currentPath.startsWith("/en") ? "en" : "ar";

const story: WebStoryResponse | null = await (async () => {
  try {
    const req = new RequestModel();
    req.lang = lang;
    req.slug = slug;

    const result: ApiResponse = await apiCalls(req, EndPointPaths.getstorybyslug);
    if (result.status === 0) {
      const resp: ResponseModel = result.data;
      if (resp.statusCode === 0) {
        return resp.respObject as WebStoryResponse;
      }
    }
  } catch (e) {
    console.error("WebStory error:", e);
  }
  return null;
})();

if (!story) {
  return new Response("Story not found", { status: 404 });
}

const toSeconds = (sec: number) => `${sec}s`;
const firstSlideBg = `url(${story.landScapeBanner})`;

// Generate full URLs for related stories
// const baseUrl = Astro.url.origin;
const baseUrl = await buildLangUrl(lang);
const canonicalUrl = baseUrl + "story/" + story.slug;
const siteName = metaConfig.siteName[lang];
const relatedItems = story.relatedStories.map(rel => ({
  title: rel.title,
  url: `${baseUrl}/stories/${rel.slug}`,
  image: rel.squareBanner || rel.landScapeBanner
}));
---

<!doctype html>
<html âš¡ lang={lang}>
  <head>
     <meta charset="utf-8" />
        <meta
            name="viewport"
            content="width=device-width,minimum-scale=1,initial-scale=1"
        />
        <title>{story.metaTitle || story.title}</title>
        <meta name="description" content={story.metaDescription || story.title} />
        <meta name="robots" content="max-image-preview:large" />
        <meta property="title" content={story.metaTitle} />
        <meta property="keywords" name={story.keywords} />
        <meta property="quiz_keywords" name={story.keywords} />
        <meta property="og:title" content={story.metaTitle} />
        <meta property="og:image" content={story.landScapeBanner} />
        <meta property="og:url" content={canonicalUrl} />
        <meta property="og:type" content="quiz" />
        <meta property="og:description" content={story.metaDescription} />
        <meta property="og:published_time" content={new Date(story.publishDate).toISOString()} />
        <meta property="og:modified_time" content={new Date(story.publishDate).toISOString()} />
        <meta property="og:site_name" content={siteName} />
        <meta name="twitter:title" content={story.metaTitle} />
        <meta name="twitter:description" content={story.metaDescription} />
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:image" content={story.landScapeBanner} />
        <meta name="amp-story-generator-name" content={siteName} />
        <meta name="amp-story-generator-version" content="0.1" />
        <link rel="canonical" href={canonicalUrl} />
        <link href={story.bannerImage} rel="preload" as="image" />
        <link
            rel="icon"
            type="image/png"
            sizes="32x32"
            href="https://www.quronfula.com/icons/favicon-32x32.png"
        />
        <link
            rel="apple-touch-icon"
            sizes="180x180"
            href="https://www.quronfula.com/icons/apple-icon-180x180.png"
        />
        <link
            rel="shortcut icon"
            href="https://www.quronfula.com/icons/favicon.ico"
            type="image/x-icon"
        />
        <link
            href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap"
            rel="stylesheet"
        />


    <!-- JSON-LD -->
    <script type="application/ld+json">
      {
        "@context": "http://schema.org",
        "@type": "NewsArticle",
        "headline": {JSON.stringify(story.title)},
        "image": [{JSON.stringify(story.landScapeBanner)}],
        "datePublished": {JSON.stringify(story.publishDate)},
        "publisher": {
          "@type": "Organization",
          "name": "Quronfula",
          "logo": {
            "@type": "ImageObject",
            "url": "https://www.quronfula.com/logo.png",
            "width": 600,
            "height": 60
          }
        }
      }
    </script>

    <!-- AMP Scripts -->
    <script async src="https://cdn.ampproject.org/v0.js"></script>
    <script async custom-element="amp-story" src="https://cdn.ampproject.org/v0/amp-story-1.0.js"></script>
    <script async custom-element="amp-animation" src="https://cdn.ampproject.org/v0/amp-animation-0.1.js"></script>
<script async custom-element="amp-story-bookend" src="https://cdn.ampproject.org/v0/amp-story-bookend-0.1.js"></script>


    <style amp-boilerplate>
      body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}
    </style>
    <noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>

    <style amp-custom>
      @font-face {
        font-family: 'Google Sans';
        font-style: normal;
        font-weight: 700;
        src: url(https://fonts.gstatic.com/s/googlesans/v14/4UabrENHsxJlGDuGo1OIlLU94Y5rI2A.woff2) format('woff2');
      }
      .center-text {
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 40px;
        color: white;
        text-shadow: 0 2px 10px rgba(0,0,0,0.6);
      }
      h1 { font-size: 48px; font-weight: bold; margin: 0 0 20px; font-family: 'Google Sans', sans-serif; }
      h2 { font-size: 42px; margin: 0 0 16px; }
      p { font-size: 28px; line-height: 1.4; max-width: 90%; }
      .button {
        margin-top: 30px;
        background: rgba(255,255,255,0.2);
        padding: 14px 28px;
        border-radius: 50px;
        text-decoration: none;
        color: white;
        font-weight: bold;
        border: 2px solid white;
        display: inline-block;
      }
    </style>
  </head>

  <body>
    <amp-story
      standalone
      title={story.title}
      publisher="The Story Circuit"
      publisher-logo-src="https://www.quronfula.com/logo.png"
      poster-portrait-src={story.squareBanner}
      poster-square-src={story.squareBanner}
      poster-landscape-src={story.landScapeBanner}
    >

      <!-- Cover Slide -->
      <amp-story-page id="cover" auto-advance-after="2s">
        <amp-story-grid-layer template="fill">
          <div animate-in="fade-in" animate-in-duration="0.8s"
            style={`background-image: ${firstSlideBg}; background-size: cover; background-position: center;`}>
          </div>
        </amp-story-grid-layer>
        <amp-story-grid-layer template="vertical" class="center-text">
          <h1 animate-in="fly-in-bottom" animate-in-duration="0.8s" animate-in-delay="0.4s">
            {story.title}
          </h1>
          <p animate-in="whoosh-in-right" animate-in-duration="0.6s" animate-in-delay="0.8s">
            By {story.author_name}
          </p>
        </amp-story-grid-layer>
      </amp-story-page>

      <!-- Content Slides -->
      {story.slides.map(slide => (
        <amp-story-page id={slide.id} auto-advance-after={toSeconds(slide.duration)}>
          <amp-story-grid-layer template="fill">
            <div class="gradient-bg" style={`background: ${slide.background};`}></div>
          </amp-story-grid-layer>
          <amp-story-grid-layer template="vertical" class="center-text">
            <h1 animate-in="fly-in-top" animate-in-duration="0.7s" animate-in-delay="0.3s">
              {slide.heading}
            </h1>
            <p animate-in="fade-in" animate-in-duration="1s" animate-in-delay="0.8s">
              {slide.text}
            </p>
          </amp-story-grid-layer>
        </amp-story-page>
      ))}

      <!-- Final CTA Slide -->
      <!-- Final CTA Slide - NOW WITH AUTO-ADVANCE (REQUIRED FOR BOOKEND!) -->
<amp-story-page id="cta" auto-advance-after="7s">
  <amp-story-grid-layer template="fill">
    <div style="background: linear-gradient(135deg, #667eea, #764ba2);"></div>
  </amp-story-grid-layer>
  <amp-story-grid-layer template="vertical" class="center-text">
    <h2 animate-in="drop-in">Thanks for reading!</h2>
    <p animate-in="fade-in" animate-in-delay="0.6s">{story.cta}</p>
    <a href={story.referenceLink} class="button">Read Full Article</a>
  </amp-story-grid-layer>
</amp-story-page>


    </amp-story>
  </body>
</html>