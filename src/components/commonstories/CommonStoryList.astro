---
import {
    apiCalls,
    buildLangUrl,
    checkForDecode,
    generateBreadcrumb,
    generateItemList,
} from "@lib/postmethodService";
import { EndPointPaths } from "@lib/EndPointPaths";
import { RequestModel } from "@lib/pojo/requestmodel/RequestModel";
import Layout from "@layouts/Layout.astro";
import SEO from "@components/SEO.astro";
import { metaConfig } from "@components/metaConfig";
import { getAppConfig } from "@lib/AppConfig";
import { getLangPrefix } from "@lib/postmethodService";
import type { ApiResponse } from "@lib/pojo/responsemodel/ApiResponse";
import type { ResponseModel } from "@lib/pojo/responsemodel/ResponseModel";
import type { WebStoryResponse } from "@lib/pojo/responsemodel/WebStoryResponse";
import { Image } from "astro:assets";
import AdPlaceholder from "@components/AdPlaceholder.astro";
// const lang = Astro.url.pathname.startsWith("/en") ? "en" : "ar";
const { lang } = Astro.props;
// Fetch homepage data or articles specific to home page
const pageParam = Astro.url.searchParams.get("page");
const currentPage = pageParam ? parseInt(pageParam, 10) : 1;
const limit = 10;
const offset = (currentPage - 1) * limit;
const webStoryCache: Map<string, WebStoryResponse[]> = new Map();

async function getStories(
    lang: string,
    catslug: string,
    subCatSlug: string,
): Promise<WebStoryResponse[] | null> {
    const cacheKey = `${lang}_${"stories"}`;
    if (webStoryCache.has(cacheKey)) return webStoryCache.get(cacheKey)!;

    const request = new RequestModel();
    request.lang = lang;
    request.limit = limit;
    request.offset = offset;
    if (catslug) {
        request.slug = await checkForDecode(catslug);
    }
    if (subCatSlug) {
        request.extraVariable = await checkForDecode(subCatSlug);
    }
    try {
        const response: ApiResponse = await apiCalls(
            request,
            EndPointPaths.getstoriesbycategoryslug,
        );

        if (response.status !== 0) return null;

        const resp: ResponseModel = response.data;
        webStoryCache.set(
            cacheKey,
            resp.statusCode === 0 ? resp.respList : null,
        ); // ‚úÖ cache the result
        return resp.statusCode === 0 ? resp.respList : null;
    } catch (error) {
        console.error("Error fetching storieslist:", error);
        return null;
    }
}

const storyList: Array<WebStoryResponse> = await getStories(lang, null, null);

const langPrefix = getLangPrefix(lang);
const apiServer = await getAppConfig();
const baseUrl = await buildLangUrl(lang);
const canonicalUrl =
    currentPage === 1
        ? `${baseUrl}stories`
        : `${baseUrl}stories?page=${currentPage}`;
const siteName = metaConfig.siteName[lang];
const title = "Quronfula Stories Collection";
const description =
    "Explore fun, engaging stories across various topics including culture, lifestyle, creativity, and more. Challenge yourself and discover new insights!";
const jsonLd = [];

const itemListJson = generateItemList({
    name: title,
    description: description,
    baseUrl: canonicalUrl,
    listUrl: canonicalUrl,
    items: storyList.map((a) => ({
        title: a.title,
        slug: a.slug,
        image: a.landScapeBanner,
        authorName: a.author_name,
        authorSlug: a.author_slug,
        type: "WebStory",
    })),
    creatorName: siteName,
    creatorUrl: apiServer.websiteUrl,
});

const breadCrumb = generateBreadcrumb("Home Page Breadcrumbs", [
    {
        name: lang === "ar" ? "ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©" : "Home",
        url: baseUrl,
    },
    {
        name: lang === "ar" ? "ŸÇÿµÿ© ÿßŸÑŸàŸäÿ®" : "Web Story",
        url: baseUrl + "stories/",
    },
]);

jsonLd.push(breadCrumb);
jsonLd.push(itemListJson);
---

<SEO
    title={title}
    description={description}
    image={baseUrl + "storiesog.webp"}
    url={canonicalUrl}
    lang={lang}
    canonical={canonicalUrl}
    noindex={false}
    type={"CollectionPage"}
    jsonLd={jsonLd}
/>
<Layout>
    <main>
        <section>
            <h1>{lang === "ar" ? "ÿ£ÿ≠ÿØÿ´ ÿßŸÑŸÇÿµÿµ" : "Latest Stories"}</h1>

            <!-- Wrapper must exist for JS -->
            <section class="articles-grid">
                {
                    storyList?.length ? (
                        storyList.map((item) => (
                            <article class="article-card">
                                <a
                                    href={`/${langPrefix}stories/${item.slug}`}
                                    class="card-link"
                                >
                                    <div class="card-image">
                                        <Image
                                            src={item.landScapeBanner}
                                            alt={item.imageAlt || item.title}
                                            loading="lazy"
                                            width="400"
                                            height="225"
                                        />
                                    </div>
                                    <div class="card-content">
                                        <p class="section-title">
                                            {item.title}
                                        </p>
                                    </div>
                                </a>
                            </article>
                        ))
                    ) : (
                        <p class="no-articles">
                            {lang === "ar"
                                ? "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÇÿµÿµ ŸÖÿ™ÿßÿ≠ÿ©."
                                : "No stories available."}
                        </p>
                    )
                }
            </section>
            <section>
                <AdPlaceholder
                    calledFrom="storyList"
                    slot="2578599202"
                    layout="display"
                    format="auto"
                    display="block"
                    textAlign="center"
                    height={200}
                    width="100%"
                />
            </section>
            <nav class="pagination">
                {
                    currentPage > 1 && (
                        <a
                            href={`/${langPrefix}stories?page=${currentPage - 1}`}
                            rel="prev"
                            class="pagination-btn"
                        >
                            ‚Üê {lang === "ar" ? "ÿßŸÑÿ≥ÿßÿ®ŸÇ" : "Previous"}
                        </a>
                    )
                }

                <span class="page-number">
                    {
                        lang === "ar"
                            ? `ÿµŸÅÿ≠ÿ© ${currentPage}`
                            : `Page ${currentPage}`
                    }
                </span>

                {
                    storyList.length === limit && (
                        <a
                            href={`/${langPrefix}stories?page=${currentPage + 1}`}
                            rel="next"
                            class="pagination-btn"
                        >
                            {lang === "ar" ? "ÿßŸÑÿ™ÿßŸÑŸä" : "Next"} ‚Üí
                        </a>
                    )
                }
            </nav>
        </section>

        <style>
            /* ================================
       Pagination
    ================================ */
            .pagination {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 1.5rem;
                margin: 3rem 0;
            }

            .pagination-btn {
                padding: 0.6rem 1.4rem;
                border-radius: 9999px;
                text-decoration: none;
                font-weight: 600;
                border: 1px solid;
            }

            .page-number {
                font-weight: 700;
            }

            .section-title {
                font-size: 1.5rem;
                font-weight: 600;
            }
            /* =========================
   GRID
========================== */
            .articles-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 20px;
                padding: 16px;
            }

            /* =========================
   CARD (THEME NEUTRAL)
========================== */
            .article-card {
                background: var(--bg-surface);
                color: var(--text-primary);

                border-radius: 12px;
                overflow: hidden;

                box-shadow: var(--shadow-card);
                transition:
                    transform 0.3s ease,
                    box-shadow 0.3s ease;
            }

            .article-card:hover {
                transform: translateY(-6px);
            }

            /* =========================
   LINK RESET
========================== */
            .card-link {
                display: block;
                color: inherit;
                text-decoration: none;
            }

            /* =========================
   IMAGE
========================== */
            .card-image {
                position: relative;
                height: 0;
                padding-top: 56.25%; /* 16:9 */
                overflow: hidden;
            }

            .card-image img {
                position: absolute;
                inset: 0;

                width: 100%;
                height: 100%;
                object-fit: cover;

                transition: transform 0.5s ease;
            }

            .article-card:hover .card-image img {
                transform: scale(1.05);
            }

            /* =========================
   CONTENT
========================== */
            .card-content {
                padding: 12px 16px;
                background: var(--bg-surface); /* üîë fixes mobile white card */
            }

            .card-content h2 {
                font-size: 18px;
                line-height: 1.3;
                margin: 0 0 6px;

                color: var(--text-primary);
            }

            .card-content p {
                font-size: 14px;
                margin: 0;

                color: var(--text-secondary);
            }

            /* =========================
   EMPTY STATE
========================== */
            .no-articles {
                text-align: center;
                font-size: 16px;
                padding: 20px;

                color: var(--text-secondary);
            }

            /* =========================
   RTL SUPPORT
========================== */
            html[lang="ar"] .card-content h2,
            html[lang="ar"] .card-content p {
                text-align: right;
            }
        </style>
    </main>
</Layout>
