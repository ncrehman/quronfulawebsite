---
import {
	apiCalls,
	buildLangUrl,
	generateBreadcrumb,
	generateItemList,
} from "@lib/postmethodService";
import { EndPointPaths } from "@lib/EndPointPaths";
import { RequestModel } from "@lib/pojo/requestmodel/RequestModel";
import { ArticleResponse } from "@lib/pojo/responsemodel/ArticleResponse";
import HeroFeatured from "@components/commonHome/HeroFeatured.astro";
import Layout from "@layouts/Layout.astro";
import SEO from "@components/SEO.astro";
import { metaConfig } from "@components/metaConfig";
import { getAppConfig } from "@lib/AppConfig";
import { WebStoryResponse } from "@lib/pojo/responsemodel/WebStoryResponse";
import { QuizStoryResponse } from "@lib/pojo/responsemodel/QuizStoryResponse";
import { checkForDecode } from "@lib/postmethodService";
import { ApiResponse } from "@lib/pojo/responsemodel/ApiResponse";
import { ResponseModel } from "@lib/pojo/responsemodel/ResponseModel";
import { getLangPrefix } from "@lib/postmethodService";

import keywordsData from "./keyword.json";
import type { KeywordsData } from "./keywords";
import KeywordsGrid from "./KeywordsGrid.astro";
import CategoryFeature from "./CategoryFeature.astro";
import SocialShare from "@components/common/SocialShare.astro";
import SampleDesign from "./SampleDesign.astro";
import AdPlaceholder from "@components/AdPlaceholder.astro";
import type { HomeDataResponse } from "@lib/pojo/responsemodel/HomeDataResponse";
import { loadContent } from "@lib/contentLoader";
import { Image } from "astro:assets";
const keyData = keywordsData as KeywordsData;
const { lang } = Astro.props;

// Fetch homepage data or articles specific to home page

const articleCache: Map<string, ArticleResponse[]> = new Map();
const webStoryCache = new Map<string, Array<WebStoryResponse>>();
const quizCache = new Map<string, Array<QuizStoryResponse>>();
async function getArticle(language: string): Promise<ArticleResponse[] | null> {
	const cacheKey = `${language}_home_${"article"}`;
	if (articleCache.has(cacheKey)) {
		return articleCache.get(cacheKey)!;
	}
	const request = new RequestModel();
	request.lang = language;
	request.offset = 0;
	request.limit = 12;
	const response = await apiCalls(request, EndPointPaths.getlatestarticle);
	if (response.status !== 0) return null;
	const articleList = response.data?.respList;
	if (articleList) {
		articleCache.set(cacheKey, articleList);
	}
	return articleList as ArticleResponse[];
}
async function getStories(
	lang: string,
	catslug: string,
	subCatSlug: string,
): Promise<WebStoryResponse[] | null> {
	const cacheKey = `${lang}_home_${"webstories"}`;
	if (webStoryCache.has(cacheKey)) return webStoryCache.get(cacheKey)!;

	const request = new RequestModel();
	request.lang = lang;
	request.limit = 12;
	request.offset = 0;
	if (catslug) {
		request.slug = await checkForDecode(catslug);
	}
	if (subCatSlug) {
		request.extraVariable = await checkForDecode(subCatSlug);
	}
	try {
		const response: ApiResponse = await apiCalls(
			request,
			EndPointPaths.getstoriesbycategoryslug,
		);

		if (response.status !== 0) return null;

		const resp: ResponseModel = response.data;
		return resp.statusCode === 0 ? resp.respList : null;
	} catch (error) {
		console.error("Error fetching webstory:", error);
		return null;
	}
}

async function getQuizStories(
	lang: string,
	catslug: string,
	subCatSlug: string,
): Promise<QuizStoryResponse[] | null> {
	const cacheKey = `${lang}_home_${"quizstories"}`;
	if (quizCache.has(cacheKey)) return quizCache.get(cacheKey)!;

	const request = new RequestModel();
	request.lang = lang;
	request.limit = 12;
	request.offset = 0;
	if (catslug) {
		request.slug = await checkForDecode(catslug);
	}
	if (subCatSlug) {
		request.extraVariable = await checkForDecode(subCatSlug);
	}
	try {
		const response: ApiResponse = await apiCalls(
			request,
			EndPointPaths.getquizbycategoryslug,
		);

		if (response.status !== 0) return null;

		const resp: ResponseModel = response.data;
		webStoryCache.set(
			cacheKey,
			resp.statusCode === 0 ? resp.respList : null,
		); // ✅ cache the result
		return resp.statusCode === 0 ? resp.respList : null;
	} catch (error) {
		console.error("Error fetching quizlist:", error);
		return null;
	}
}
let articles: Array<ArticleResponse>;
let featureList: Array<ArticleResponse>;
let stories: Array<WebStoryResponse>;
let quizzes: Array<QuizStoryResponse>;
let homeData: HomeDataResponse = await loadContent("home", "homepage", lang);
if (homeData) {
	articles = homeData.articleList ?? (await getArticle(lang));
	stories = homeData.storyList ?? (await getStories(lang, null, null));
	quizzes = homeData.quizList ?? (await getQuizStories(lang, null, null));
	featureList = homeData.featureList ?? null;
} else {
	articles = await getArticle(lang);
	stories = await getStories(lang, null, null);
	quizzes = await getQuizStories(lang, null, null);
}

if (!featureList) {
	featureList = articles.slice(0, 3);
}

const langPrefix = await getLangPrefix(lang);
const apiServer = await getAppConfig();

const baseUrl = await buildLangUrl(lang);
const canonicalUrl = baseUrl.replace(/\/$/, "");
const siteName = metaConfig.siteName[lang];
const title = metaConfig.title[lang];
const description = metaConfig.description[lang];
const jsonLd = [];
const webSiteSchema = {
	"@context": "https://schema.org",
	"@type": "WebSite",
	"@id": apiServer.websiteUrl + "#website",
	name: siteName,
	url: baseUrl,
	publisher: {
		"@id": apiServer.websiteUrl + "#organization",
	},
	potentialAction: {
		"@type": "SearchAction",
		target: baseUrl + "search?q={search_term_string}",
		"query-input": "required name=search_term_string",
	},
};
jsonLd.push(webSiteSchema);

const organizationSchema = {
	"@context": "https://schema.org",
	"@type": "Organization",
	"@id": apiServer.websiteUrl + "#organization",
	name: siteName,
	url: baseUrl,
	logo:
		apiServer.websiteUrl.replace(/\/$/, "") +
		"/icons/android-icon-192x192.png",
};
jsonLd.push(organizationSchema);

const breadCrumb = generateBreadcrumb("Home Page Breadcrumbs", [
	{
		name: lang === "ar" ? "الرئيسية" : "Home",
		url: baseUrl,
	},
]);
jsonLd.push(breadCrumb);

if (articles) {
	const itemListJson = generateItemList({
		name: "Quronfula Article Collection",
		description:
			"Explore our collection of in-depth articles covering culture, trends, lifestyle, creativity, and modern storytelling. Updated regularly with fresh insights and inspiration.",
		baseUrl: baseUrl + "article/",
		listUrl: baseUrl + "article/",
		items: articles.map((a) => ({
			title: a.title,
			slug: a.slug,
			image: a.landScapeBanner,
			authorName: a.authorName,
			authorSlug: a.authorSlug,
			type: "Article",
		})),
		creatorName: siteName,
		creatorUrl: apiServer.websiteUrl,
	});
	jsonLd.push(itemListJson);
}

const content = {
	en: {
		title: "Quronfula – Articles, Web Stories, Quizzes & Daily Insights",
		h1: "Latest Articles, Web Stories, Quizzes & Daily Insights from Quronfula",

		p1: "Quronfula is your premier digital platform for the latest articles, web stories, quizzes, and daily insights that shape modern life. Every day, we publish thoughtfully curated content covering culture, lifestyle, knowledge, technology, wellness, and contemporary issues.",

		p2: "Through meticulously researched articles, interactive quizzes, and authentic storytelling, Quronfula delivers meaningful daily insights that help readers understand the world better. Whether you are looking for in-depth analysis, inspiring stories, practical life advice, or fresh perspectives, our content is designed to inform, engage, and empower.",

		p3: "Join a growing global community that visits Quronfula daily to explore the latest articles, web stories, and quizzes. Stay updated with trusted insights, discover new ideas, and navigate modern life with clarity, confidence, and purpose.",
	},

	ar: {
		title: "قرنفلة – مقالات، قصص ويب، مسابقات ومعلومات يومية",
		h1: "أحدث المقالات وقصص الويب والمسابقات والمعلومات اليومية من قرنفلة",

		p1: "قرنفلة منصة رقمية تقدم أحدث المقالات وقصص الويب والمسابقات والمعلومات اليومية التي تواكب الحياة المعاصرة. ننشر يوميًا محتوى متنوعًا يشمل الثقافة، ونمط الحياة، والمعرفة، والتكنولوجيا، والصحة، وقضايا المجتمع.",

		p2: "من خلال مقالات مدروسة بعمق، ومسابقات تفاعلية، وسرد قصصي أصيل، تقدم قرنفلة معلومات يومية ورؤى معرفية تساعد القراء على فهم العالم من حولهم. سواء كنتم تبحثون عن تحليلات معمقة، أو قصص ملهمة، أو نصائح عملية للحياة اليومية، فإن محتوى قرنفلة صُمم ليكون موثوقًا وهادفًا.",

		p3: "انضموا إلى مجتمع قرنفلة المتنامي الذي يزور المنصة يوميًا لاكتشاف أحدث المقالات وقصص الويب والمسابقات. تابعوا المعلومات اليومية، واستلهموا أفكارًا جديدة، وابقوا على اطلاع دائم بما يساعدكم على مواجهة تحديات الحياة الحديثة بثقة ووعي.",
	},
};

const data = content[lang];
---

<SEO
	title={title}
	description={description}
	image={baseUrl + "ogimage.webp"}
	url={canonicalUrl}
	lang={lang}
	canonical={canonicalUrl}
	noindex={false}
	type={"WebSite"}
	jsonLd={jsonLd}
/>
<Layout>
	<main>
		<>
			<!-- <SampleDesign /> -->
			<HeroFeatured articles={featureList} lang={lang} />
			<!-- <section><CategoryFeature lang={lang} /> -->
			<h2 class="sr-only">
				Explore the latest articles, stories, and insights on culture,
				lifestyle, and modern living
			</h2>
		</>
		<section>
			<div id="container-7538bd9c37b3bc6235c127a4b18d2e6c"></div>
		</section>
		{
			articles ? (
				<section>
					<div style="font-weight:700;">
						{lang === "ar" ? "مقالات جديدة" : "Latest Articles"}
					</div>
					<section class="articles-grid">
						{articles?.length ? (
							articles.map((item) => (
								<article class="article-card">
									<a
										href={`/${langPrefix}article/${item.slug}`}
										class="card-link"
										aria-label={`Read article: ${item.title}`}
									>
										<div class="card-image">
											<Image
												src={item.landScapeBanner}
												alt={
													item.imageAlt || item.title
												}
												loading="lazy"
												width="400"
												height="225"
											/>
										</div>
										<div
											class="card-content"
											style="font-weight:600;"
										>
											{item.title}
										</div>
									</a>
								</article>
							))
						) : (
							<p class="no-articles">
								{lang === "ar"
									? "لا توجد مقالات."
									: "No articles available."}
							</p>
						)}
					</section>
				</section>
			) : null
		}
		<section>
			<AdPlaceholder
				calledFrom="home1"
				slot="2578599202"
				layout="display"
				format="auto"
				display="block"
				textAlign="center"
				height={200}
				width="100%"
			/>
		</section>
		{
			stories ? (
				<section>
					<div style="font-weight:700;">
						{lang === "ar"
							? "أحدث قصص الويب"
							: "Latest Web Stories"}
					</div>
					<section class="articles-grid">
						{stories?.length ? (
							stories.map((item) => (
								<stories class="article-card">
									<a
										href={`/${langPrefix}stories/${item.slug}`}
										class="card-link"
										aria-label={`Read web story: ${item.title}`}
									>
										<div class="card-image">
											<Image
												src={item.landScapeBanner}
												alt={
													item.imageAlt || item.title
												}
												loading="lazy"
												width={400}
												height={225}
											/>
										</div>
										<div
											class="card-content"
											style="font-weight:600;"
										>
											{item.title}
										</div>
									</a>
								</stories>
							))
						) : (
							<p class="no-articles">
								{lang === "ar"
									? "لا توجد قصص متاحة."
									: "No stories available."}
							</p>
						)}
					</section>
				</section>
			) : null
		}
		<section>
			<AdPlaceholder
				calledFrom="home1"
				slot="4358584730"
				layout="display"
				format="auto"
				display="block"
				textAlign="center"
				height={200}
				width="100%"
			/>
		</section>
		{
			quizzes ? (
				<section>
					<div style="font-weight:700;">
						{lang === "ar" ? "أحدث المسابقات" : "Latest Quizzes"}
					</div>
					<section class="articles-grid">
						{quizzes?.length ? (
							quizzes.map((item) => (
								<quiz class="article-card">
									<a
										href={`/${langPrefix}quiz/${item.slug}`}
										class="card-link"
										aria-label={`Take quiz: ${item.title}`}
									>
										<div class="card-image">
											<Image
												src={item.landScapeBanner}
												alt={
													item.imageAlt || item.title
												}
												loading="lazy"
												width="400"
												height="225"
											/>
										</div>
										<div
											class="card-content"
											style="font-weight:600;"
										>
											{item.title}
										</div>
									</a>
								</quiz>
							))
						) : (
							<p class="no-articles">
								{lang === "ar"
									? "لا يوجد اختبار متاح."
									: "No quiz available."}
							</p>
						)}
					</section>
				</section>
			) : null
		}
		<section>
			<AdPlaceholder
				calledFrom="home1"
				slot="1732421390"
				layout="display"
				format="auto"
				display="block"
				textAlign="center"
				height={200}
				width="100%"
			/>
		</section>
		<section
			class="seo-intro"
			lang={lang}
			dir={lang === "ar" ? "rtl" : "ltr"}
		>
			<h1>{data.h1}</h1>
			<p>{data.p1}</p>
			<p>{data.p2}</p>
		</section>

		<section>
			<div
				style={{
					fontSize: "36px",
					fontWeight: 800,
					textAlign: "center",
					marginTop: "20px",
					marginBottom: "40px",
					color: "#0f0f0f",
				}}
			>
				<KeywordsGrid items={keyData[lang]} lang={lang} />
			</div>
		</section>
		<section>
			<div id="container-7538bd9c37b3bc6235c127a4b18d2e6c"></div>
		</section>
		<SocialShare title={title} url={canonicalUrl} lang={lang} />
		<a
			href="https://thestorycircuit.com/"
			target="_blank"
			rel="noopener noreferrer"
			class="story-circuit-promo"
		>
			<div class="promo-card">
				<div class="card-background"></div>
				<div class="card-content">
					<h3 class="promo-title">The Story Circuit</h3>
					<p class="promo-tagline">
						{
							lang === "en"
								? "Deep Stories • Healing Journeys • Meaningful Conversations"
								: "قصص عميقة • رحلات شفاء • حوارات هادفة محادثات"
						}
					</p>
					<p class="promo-desc">
						{
							lang === "en"
								? "Explore thoughtful articles, web stories, interactive quizes, and free online tools on emotional healing, lifestyle, creativity, Sudanese culture, tech, side hustles, and personal growth."
								: "استكشف المقالات القيّمة، والقصص الإلكترونية، والاختبارات التفاعلية، والأدوات المجانية عبر الإنترنت حول الشفاء العاطفي، وأسلوب الحياة، والإبداع، والثقافة السودانية، والتكنولوجيا، والمشاريع الجانبية، والنمو الشخصي."
						}
					</p>
					<span class="promo-cta"
						>{
							lang === "en"
								? "Discover Inspiring Stories"
								: "اكتشف قصصًا ملهمة"
						} →</span
					>
				</div>
			</div>
		</a>

		<style>
			/* ===============================
   LOCAL THEME (HOME PAGE ONLY)
================================ */
			html {
				--bg-page: #ffffff;
				--bg-card: #ffffff;
				--bg-muted: #f8fafc;

				--text-main: #0f172a;
				--text-muted: #475569;

				--border-soft: #e5e7eb;
				--shadow-card: 0 8px 24px rgba(0, 0, 0, 0.08);
			}

			/* ===== DARK MODE (iOS SAFE) ===== */
			@media (prefers-color-scheme: dark) {
				html {
					--bg-page: #0b0f19;
					--bg-card: #0f172a;
					--bg-muted: #111827;

					--text-main: #e5e7eb;
					--text-muted: #9ca3af;

					--border-soft: #1f2937;
					--shadow-card: 0 10px 30px rgba(0, 0, 0, 0.6);
				}
			}

			/* ===============================
   PAGE BASE
================================ */
			main {
				background: var(--bg-page);
				color: var(--text-main);
				-webkit-text-size-adjust: 100%;
			}

			/* ===============================
   GRID (SAFARI STABLE)
================================ */
			.articles-grid {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
				gap: 20px;
				padding: 16px 0;
			}

			/* ===============================
   CARD
================================ */
			.article-card {
				background: var(--bg-card);
				border-radius: 14px;
				overflow: hidden;
				border: 1px solid var(--border-soft);
				box-shadow: var(--shadow-card);

				/* iOS GPU FIX */
				-webkit-transform: translateZ(0);
				transform: translateZ(0);
				will-change: transform;

				transition:
					transform 0.3s ease,
					box-shadow 0.3s ease;
			}

			@media (hover: hover) {
				.article-card:hover {
					transform: translateY(-6px);
				}
			}

			/* ===============================
   LINK RESET
================================ */
			.card-link {
				display: block;
				color: inherit;
				text-decoration: none;
			}

			/* ===============================
   IMAGE (iOS SAFE)
================================ */
			.card-image {
				position: relative;
				aspect-ratio: 16 / 9;
				overflow: hidden;
				background: #000;
			}

			.card-image img {
				width: 100%;
				height: 100%;
				object-fit: cover;

				/* Prevent iOS dark overlay bug */
				-webkit-transform: translateZ(0);
				transform: translateZ(0);

				transition: transform 0.4s ease;
			}

			@media (hover: hover) {
				.article-card:hover img {
					transform: scale(1.05);
				}
			}

			/* ===============================
   CARD CONTENT
================================ */
			.card-content {
				padding: 14px 16px;
				font-size: 16px;
				font-weight: 600;
				line-height: 1.45;
				color: var(--text-main);

				/* Text clarity on iOS */
				-webkit-font-smoothing: antialiased;
			}

			/* ===============================
   EMPTY STATE
================================ */
			.no-articles {
				text-align: center;
				padding: 24px;
				color: var(--text-muted);
			}

			/* ===============================
   SEO INTRO
================================ */
			.seo-intro {
				max-width: 900px;
				margin: 3rem auto;
				padding: 2.5rem;
				background: var(--bg-muted);
				border-radius: 16px;
				border: 1px solid var(--border-soft);
			}

			.seo-intro h1 {
				font-size: clamp(1.8rem, 2.5vw, 2.4rem);
				margin-bottom: 1rem;
				color: var(--text-main);
			}

			.seo-intro p {
				font-size: 1.05rem;
				line-height: 1.8;
				color: var(--text-muted);
			}

			/* ===============================
   PROMO CARD
================================ */
			.story-circuit-promo {
				display: block;
				max-width: 420px;
				margin: 3rem auto;
				text-decoration: none;
			}

			.promo-card {
				border-radius: 26px;
				background: var(--bg-card);
				border: 1px solid var(--border-soft);
				box-shadow: var(--shadow-card);
				padding: 36px 28px;
				text-align: center;

				-webkit-transform: translateZ(0);
				transform: translateZ(0);

				transition: transform 0.4s ease;
			}

			@media (hover: hover) {
				.promo-card:hover {
					transform: translateY(-8px);
				}
			}

			.promo-title {
				font-size: 2rem;
				font-weight: 900;
				margin-bottom: 0.8rem;
				background: linear-gradient(90deg, #9333ea, #3b82f6);
				-webkit-background-clip: text;
				-webkit-text-fill-color: transparent;
			}

			.promo-tagline {
				font-weight: 600;
				font-style: italic;
				margin-bottom: 1.2rem;
				color: var(--text-main);
			}

			.promo-desc {
				line-height: 1.7;
				margin-bottom: 1.6rem;
				color: var(--text-muted);
			}

			.promo-cta {
				font-weight: 700;
				color: #7c3aed;
			}

			/* ===============================
   RTL SUPPORT
================================ */
			html[lang="ar"] .card-content,
			html[lang="ar"] .seo-intro {
				text-align: right;
			}

			/* ===============================
   MOBILE SAFETY
================================ */
			@media (max-width: 480px) {
				.card-content {
					font-size: 15px;
				}
			}
		</style>
	</main>
</Layout>
