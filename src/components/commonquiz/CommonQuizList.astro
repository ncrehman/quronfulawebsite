---
import {
    apiCalls,
    buildLangUrl,
    checkForDecode,
    detectDevice,
    generateBreadcrumb,
    generateItemList,
} from "@lib/postmethodService";
import { EndPointPaths } from "@lib/EndPointPaths";
import { RequestModel } from "@lib/pojo/requestmodel/RequestModel";
import Layout from "@layouts/Layout.astro";
import SEO from "@components/SEO.astro";
import { metaConfig } from "@components/metaConfig";
import { getAppConfig } from "@lib/AppConfig";
import { getLangPrefix } from "@lib/postmethodService";
import type { ApiResponse } from "@lib/pojo/responsemodel/ApiResponse";
import type { ResponseModel } from "@lib/pojo/responsemodel/ResponseModel";
import type { QuizStoryResponse } from "@lib/pojo/responsemodel/QuizStoryResponse";
import { Image } from "astro:assets";
import AdPlaceholder from "@components/AdPlaceholder.astro";
import { generateSeo } from "@lib/MetaDescriptionUtil";
import type { MetaObject } from "@lib/MetaObject";
import SocialShare from "@components/common/SocialShare.astro";
const { lang } = Astro.props;
const pageParam = Astro.url.searchParams.get("page");
const currentPage = pageParam ? parseInt(pageParam, 10) : 1;
const limit = 10;
const offset = (currentPage - 1) * limit;
const webStoryCache: Map<string, QuizStoryResponse[]> = new Map();

async function getQuizStories(
    lang: string,
    catslug: string,
    subCatSlug: string,
): Promise<QuizStoryResponse[] | null> {
    const cacheKey = `${lang}_${"quizstories"}`;
    if (webStoryCache.has(cacheKey)) return webStoryCache.get(cacheKey)!;

    const request = new RequestModel();
    request.lang = lang;
    request.limit = limit;
    request.offset = offset;
    if (catslug) {
        request.slug = await checkForDecode(catslug);
    }
    if (subCatSlug) {
        request.extraVariable = await checkForDecode(subCatSlug);
    }
    try {
        const response: ApiResponse = await apiCalls(
            request,
            EndPointPaths.getquizbycategoryslug,
        );

        if (response.status !== 0) return null;

        const resp: ResponseModel = response.data;
        webStoryCache.set(
            cacheKey,
            resp.statusCode === 0 ? resp.respList : null,
        ); // âœ… cache the result
        return resp.statusCode === 0 ? resp.respList : null;
    } catch (error) {
        console.error("Error fetching quizlist:", error);
        return null;
    }
}

const quizList: Array<QuizStoryResponse> = await getQuizStories(
    lang,
    null,
    null,
);

const langPrefix = await getLangPrefix(lang);
const apiServer = await getAppConfig();
const baseUrl = await buildLangUrl(lang);
const canonicalUrl =
    currentPage === 1 ? `${baseUrl}quiz` : `${baseUrl}quiz?page=${currentPage}`;
const siteName = metaConfig.siteName[lang];
const quizBaseHeading =
    lang === "ar"
        ?"Ø£Ø­Ø¯Ø« Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª â€“ Ù…Ø­ØªÙˆÙ‰ ØªÙØ§Ø¹Ù„ÙŠ Ù„ØªØ¹Ø²ÙŠØ² Ø§Ù„Ù…Ø¹Ø±ÙØ©"
        : "Latest Quiz Collection â€“ Fun & Knowledge-Boosting Quizes";

const isPageOne = currentPage === 1;

const title = isPageOne
    ? quizBaseHeading
    : lang === "ar"
      ? `${quizBaseHeading} â€“ Ø§Ù„ØµÙØ­Ø© ${currentPage}`
      : `${quizBaseHeading} â€“ Page ${currentPage}`;

const description = isPageOne
    ? lang === "ar"
        ? "Ø§Ø®ØªØ¨Ø± Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ù…Ø¹ Ø£Ø­Ø¯Ø« Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø¹Ù„Ù‰ ÙƒÙˆØ±ÙˆÙ†ÙÙˆÙ„Ø§. Ø§Ø³ØªÙƒØ´Ù Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù…Ù…ØªØ¹Ø© ÙˆØªÙØ§Ø¹Ù„ÙŠØ© ÙÙŠ Ù…Ø¬Ø§Ù„Ø§Øª Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„Ø­ÙŠØ§Ø© ÙˆØ§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ ÙˆØºÙŠØ±Ù‡Ø§."
        : "Play the latest quizes on Quronfula and test your knowledge. Explore fun, engaging quizes across lifestyle, creativity, and more."
    : lang === "ar"
      ? `Ø§ÙƒØªØ´Ù Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù…ØªØ¹Ø© Ø¹Ù„Ù‰ ÙƒÙˆØ±ÙˆÙ†ÙÙˆÙ„Ø§. ØªØµÙØ­ Ø§Ù„ØµÙØ­Ø© ${currentPage} Ù…Ù† Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙˆØªØ­Ø¯Ù‰ Ù†ÙØ³Ùƒ Ø¨Ø£Ø³Ø¦Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©.`
      : `Explore more fun and engaging quizes on Quronfula. Browse page ${currentPage} of our quiz collection and challenge yourself.`;

const jsonLd = [];

const itemListJson = generateItemList({
    name: title,
    description: description,
    baseUrl: canonicalUrl,
    listUrl: canonicalUrl,
    items: quizList.map((a) => ({
        title: a.title,
        slug: a.slug,
        image: a.landScapeBanner,
        authorName: a.author_name,
        authorSlug: a.author_slug,
        type: "Quiz",
    })),
    creatorName: siteName,
    creatorUrl: apiServer.websiteUrl,
});

const breadCrumb = generateBreadcrumb("Home Page Breadcrumbs", [
    {
        name: lang === "ar" ? "Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" : "Home",
        url: baseUrl,
    },
    {
        name: lang === "ar" ? "Ù„ØºØ²" : "quiz",
        url: baseUrl + "quiz/",
    },
]);

jsonLd.push(breadCrumb);
jsonLd.push(itemListJson);
const ua = Astro.request.headers.get("user-agent");
const device = detectDevice(ua);
const language: any = lang;
let metaObj: MetaObject = generateSeo(title, description, language, device);
---

<SEO
    title={metaObj.title}
    description={metaObj.metaDesc}
    image={baseUrl + "quizog.webp"}
    url={canonicalUrl}
    lang={lang}
    canonical={canonicalUrl}
    noindex={false}
    type={"CollectionPage"}
    jsonLd={jsonLd}
/>
<Layout>
    <main>
        <section>
            <div id="container-7538bd9c37b3bc6235c127a4b18d2e6c"></div>
        </section>
        <section>
            <div
                class="w-full bg-gradient-to-br from-emerald-50 via-white to-teal-50 rounded-2xl p-8 mb-10 text-center shadow-sm"
            >
                <h1
                    class="text-3xl md:text-5xl font-extrabold text-gray-900 mb-4"
                >
                    {
                        lang === "ar"
                            ? "Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© Ù„ØªÙ†Ù…ÙŠØ© Ø§Ù„Ù…Ø¹Ø±ÙØ© ÙˆØ§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø°ÙƒØ§Ø¡"
                            : "Latest Interactive Quizzes to Boost Knowledge & Test Your Skills"
                    }
                </h1>

                <div class="w-24 h-1 bg-emerald-500 mx-auto rounded-full mb-6">
                </div>

                {
                    lang === "ar" ? (
                        <>
                            <p class="text-lg md:text-xl text-gray-700 leading-relaxed max-w-4xl mx-auto mb-4 direction-rtl">
                                Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ù‚Ø³Ù…{" "}
                                <span class="text-emerald-600 font-semibold">
                                    Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª
                                </span>{" "}
                                Ø¹Ù„Ù‰ QuronfulaØŒ Ø­ÙŠØ« Ù†Ø¬Ù…Ø¹ Ø¨ÙŠÙ† Ø§Ù„Ù…ØªØ¹Ø© ÙˆØ§Ù„Ù…Ø¹Ø±ÙØ© ÙÙŠ
                                ØªØ¬Ø±Ø¨Ø© ØªÙØ§Ø¹Ù„ÙŠØ© ÙØ±ÙŠØ¯Ø©. Ø³ØªØ¬Ø¯ Ù‡Ù†Ø§ Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…ØªÙ†ÙˆØ¹Ø© Ù…Ù†
                                Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª Ø§Ù„Ù…ØµÙ…Ù…Ø© Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ ÙˆØªÙ†Ù…ÙŠØ©
                                Ù…Ù‡Ø§Ø±Ø§ØªÙƒ ÙÙŠ Ù…Ø¬Ø§Ù„Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø© Ù…Ø«Ù„ Ø§Ù„Ø«Ù‚Ø§ÙØ© Ø§Ù„Ø¹Ø§Ù…Ø©ØŒ
                                Ø§Ù„ØªØ§Ø±ÙŠØ®ØŒ Ø§Ù„Ø¹Ù„ÙˆÙ…ØŒ Ø§Ù„Ø±ÙŠØ§Ø¶Ø©ØŒ ÙˆØ§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¬Ø§Ø±ÙŠØ©.
                            </p>

                            <p class="text-base md:text-lg text-gray-600 leading-relaxed max-w-4xl mx-auto direction-rtl">
                                Ù†Ø­Ø±Øµ ÙÙŠ Quronfula Ø¹Ù„Ù‰ ØªÙ‚Ø¯ÙŠÙ… Ù…Ø³Ø§Ø¨Ù‚Ø§Øª ØªØ¹Ù„ÙŠÙ…ÙŠØ©
                                Ù…Ù…ØªØ¹Ø© ØªØ³Ø§Ø¹Ø¯Ùƒ Ø¹Ù„Ù‰ ØªØ·ÙˆÙŠØ± Ø§Ù„ØªÙÙƒÙŠØ± Ø§Ù„Ù†Ù‚Ø¯ÙŠ ÙˆØ²ÙŠØ§Ø¯Ø©
                                Ù…Ø®Ø²ÙˆÙ†Ùƒ Ø§Ù„Ù…Ø¹Ø±ÙÙŠ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø³ÙŠØ·Ø© ÙˆÙ…Ø³Ù„ÙŠØ©. Ø³ÙˆØ§Ø¡ ÙƒÙ†Øª
                                ØªØ¨Ø­Ø« Ø¹Ù† ØªØ­Ø¯Ù Ø³Ø±ÙŠØ¹ Ø£Ùˆ ØªØ±ØºØ¨ ÙÙŠ Ù‚Ø¶Ø§Ø¡ ÙˆÙ‚Øª Ù…Ù…ØªØ¹ Ù…Ø¹
                                Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ØŒ ÙØ¥Ù†{" "}
                                <span class="text-emerald-600 font-semibold">
                                    Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª
                                </span>{" "}
                                ØªÙ…Ù†Ø­Ùƒ Ø§Ù„ÙØ±ØµØ© Ù„Ù„ØªØ¹Ù„Ù…ØŒ Ø§Ù„ØªÙØ§Ø¹Ù„ØŒ ÙˆØªØ­Ù‚ÙŠÙ‚ Ø£ÙØ¶Ù„
                                Ø§Ù„Ù†ØªØ§Ø¦Ø¬. Ø´Ø§Ø±Ùƒ Ø§Ù„Ø¢Ù† ÙˆØ§ÙƒØªØ´Ù Ù…Ø¯Ù‰ Ù‚ÙˆØ© Ù…Ø¹Ø±ÙØªÙƒ.
                            </p>
                        </>
                    ) : (
                        <>
                            <p class="text-lg md:text-xl text-gray-700 leading-relaxed max-w-4xl mx-auto mb-4">
                                Welcome to the{" "}
                                <span class="text-emerald-600 font-semibold">
                                    latest quiz
                                </span>{" "}
                                section on Quronfula, where learning becomes
                                interactive and exciting. Here youâ€™ll find
                                quizzes designed to test your knowledge,
                                challenge your thinking, and make learning a fun
                                experience across various topics.
                            </p>

                            <p class="text-base md:text-lg text-gray-600 leading-relaxed max-w-4xl mx-auto">
                                Our{" "}
                                <span class="text-emerald-600 font-semibold">
                                    latest quiz
                                </span>{" "}
                                collection is perfect for students, quiz lovers,
                                and curious minds who enjoy discovering new
                                information. Each quiz helps improve memory,
                                sharpen skills, and expand understanding in an
                                engaging way. Take part regularly, track your
                                progress, and turn every quiz into a rewarding
                                learning journey.
                            </p>
                        </>
                    )
                }
            </div>

            <!-- Wrapper must exist for JS -->
            <section class="articles-grid">
                {
                    quizList?.length ? (
                        quizList.map((item) => (
                            <article class="article-card">
                                <a
                                    href={`/${langPrefix}quiz/${item.slug}`}
                                    class="card-link"
                                >
                                    <div class="card-image">
                                        <Image
                                            src={item.landScapeBanner}
                                            alt={item.imageAlt || item.title}
                                            width={400}
                                            height={225}
                                            loading="lazy"
                                            class="w-full h-full object-cover"
                                        />
                                    </div>

                                    <div class="card-content">
                                        <h2 class="section-title">
                                            {item.title}
                                        </h2>
                                    </div>
                                </a>
                            </article>
                        ))
                    ) : (
                        <p class="no-articles">
                            {lang === "ar"
                                ? "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø± Ù…ØªØ§Ø­."
                                : "No quiz available."}
                        </p>
                    )
                }
            </section>
            <section>
                <AdPlaceholder
                    calledFrom="QuizList"
                    slot="2578599202"
                    layout="display"
                    format="auto"
                    display="block"
                    textAlign="center"
                    height={200}
                    width="100%"
                />
            </section>
            <nav class="pagination">
                {
                    currentPage > 1 && (
                        <a
                            href={`/${langPrefix}quiz?page=${currentPage - 1}`}
                            rel="prev"
                            class="pagination-btn"
                        >
                            â† {lang === "ar" ? "Ø§Ù„Ø³Ø§Ø¨Ù‚" : "Previous"}
                        </a>
                    )
                }

                <span class="page-number">
                    {
                        lang === "ar"
                            ? `ØµÙØ­Ø© ${currentPage}`
                            : `Page ${currentPage}`
                    }
                </span>

                {
                    quizList.length === limit && (
                        <a
                            href={`/${langPrefix}quiz?page=${currentPage + 1}`}
                            rel="next"
                            class="pagination-btn"
                        >
                            {lang === "ar" ? "Ø§Ù„ØªØ§Ù„ÙŠ" : "Next"} â†’
                        </a>
                    )
                }
            </nav>
        </section>
        <SocialShare title={title} url={canonicalUrl} lang={lang} />
        <style>
            /* ================================
       Pagination
    ================================ */
            .pagination {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 1.5rem;
                margin: 3rem 0;
            }

            .pagination-btn {
                padding: 0.6rem 1.4rem;
                border-radius: 9999px;
                text-decoration: none;
                font-weight: 600;
                border: 1px solid;
            }

            .page-number {
                font-weight: 700;
            }
            .section-title {
                font-size: 1.5rem;
                font-weight: 600;
            }
            /* =========================
   GRID
========================== */
            .articles-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 20px;
                padding: 16px;
            }

            /* =========================
   CARD (THEME NEUTRAL)
========================== */
            .article-card {
                background: var(--bg-surface);
                color: var(--text-primary);

                border-radius: 12px;
                overflow: hidden;

                box-shadow: var(--shadow-card);
                transition:
                    transform 0.3s ease,
                    box-shadow 0.3s ease;
            }

            .article-card:hover {
                transform: translateY(-6px);
            }

            /* =========================
   LINK RESET
========================== */
            .card-link {
                display: block;
                color: inherit;
                text-decoration: none;
            }

            /* =========================
   IMAGE
========================== */
            .card-image {
                position: relative;
                height: 0;
                padding-top: 56.25%; /* 16:9 */
                overflow: hidden;
            }

            .card-image img {
                position: absolute;
                inset: 0;

                width: 100%;
                height: 100%;
                object-fit: cover;

                transition: transform 0.5s ease;
            }

            .article-card:hover .card-image img {
                transform: scale(1.05);
            }

            /* =========================
   CONTENT
========================== */
            .card-content {
                padding: 12px 16px;
                background: var(--bg-surface); /* ğŸ”‘ fixes mobile white card */
            }

            .card-content h2 {
                font-size: 18px;
                line-height: 1.3;
                margin: 0 0 6px;

                color: var(--text-primary);
            }

            .card-content p {
                font-size: 14px;
                margin: 0;

                color: var(--text-secondary);
            }

            /* =========================
   EMPTY STATE
========================== */
            .no-articles {
                text-align: center;
                font-size: 16px;
                padding: 20px;

                color: var(--text-secondary);
            }

            /* =========================
   RTL SUPPORT
========================== */
            html[lang="ar"] .card-content h2,
            html[lang="ar"] .card-content p {
                text-align: right;
            }
        </style>
    </main>
</Layout>
