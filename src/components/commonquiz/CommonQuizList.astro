---
import {
    apiCalls,
    buildLangUrl,
    checkForDecode,
    generateBreadcrumb,
    generateItemList,
} from "@lib/postmethodService";
import { EndPointPaths } from "@lib/EndPointPaths";
import { RequestModel } from "@lib/pojo/requestmodel/RequestModel";
import Layout from "@layouts/Layout.astro";
import SEO from "@components/SEO.astro";
import { metaConfig } from "@components/metaConfig";
import { getAppConfig } from "@lib/AppConfig";
import { getLangPrefix } from "@lib/postmethodService";
import type { ApiResponse } from "@lib/pojo/responsemodel/ApiResponse";
import type { ResponseModel } from "@lib/pojo/responsemodel/ResponseModel";
import type { QuizStoryResponse } from "@lib/pojo/responsemodel/QuizStoryResponse";
// const lang = Astro.url.pathname.startsWith("/en") ? "en" : "ar";
const { lang } = Astro.props;
let offset = 0;
// Fetch homepage data or articles specific to home page

const webStoryCache: Map<string, QuizStoryResponse[]> = new Map();

async function getQuizStories(
    lang: string,
    catslug: string,
    subCatSlug: string,
): Promise<QuizStoryResponse[] | null> {
    const cacheKey = `${lang}_${"quizstories"}`;
    if (webStoryCache.has(cacheKey)) return webStoryCache.get(cacheKey)!;

    const request = new RequestModel();
    request.lang = lang;
    request.limit = 18;
    request.offset = 0;
    if (catslug) {
        request.slug = await checkForDecode(catslug);
    }
    if (subCatSlug) {
        request.extraVariable = await checkForDecode(subCatSlug);
    }
    try {
        const response: ApiResponse = await apiCalls(
            request,
            EndPointPaths.getquizbycategoryslug,
        );

        if (response.status !== 0) return null;

        const resp: ResponseModel = response.data;
        webStoryCache.set(
            cacheKey,
            resp.statusCode === 0 ? resp.respList : null,
        ); // âœ… cache the result
        return resp.statusCode === 0 ? resp.respList : null;
    } catch (error) {
        console.error("Error fetching quizlist:", error);
        return null;
    }
}

const quizList: Array<QuizStoryResponse> = await getQuizStories(
    lang,
    null,
    null,
);

const langPrefix = getLangPrefix(lang);
const apiServer = getAppConfig();
const baseUrl = await buildLangUrl(lang);
const canonicalUrl = baseUrl + "quiz";
const siteName = metaConfig.siteName[lang];
const title = "Quronfula Quiz Collection";
const description =
    "Test your knowledge and explore fun, engaging quizes across topics including lifestyle, creativity, and more. Challenge yourself and discover new insights";
const jsonLd = [];

const itemListJson = generateItemList({
    name: title,
    description: description,
    baseUrl: baseUrl + "quiz/",
    listUrl: baseUrl + "quiz/",
    items: quizList.map((a) => ({
        title: a.title,
        slug: a.slug,
        image: a.landScapeBanner,
        authorName: a.author_name,
        authorSlug: a.author_slug,
        type: "Quiz",
    })),
    creatorName: siteName,
    creatorUrl: apiServer.websiteUrl,
});

const breadCrumb = generateBreadcrumb("Home Page Breadcrumbs", [
    {
        name: lang === "ar" ? "Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" : "Home",
        url: baseUrl,
    },
    {
        name: lang === "ar" ? "Ù„ØºØ²" : "quiz",
        url: baseUrl + "quiz/",
    },
]);

jsonLd.push(breadCrumb);
jsonLd.push(itemListJson);
---

<SEO
    title={title}
    description={description}
    image={baseUrl + "quizog.webp"}
    url={canonicalUrl}
    lang={lang}
    canonical={canonicalUrl}
    noindex={false}
    type={"WebSite"}
    jsonLd={jsonLd}
/>
<Layout>
    <main>
        <template id="article-card-template">
            <article class="article-card">
                <a href="" class="card-link">
                    <div class="card-image">
                        <img
                            src=""
                            alt=""
                            loading="lazy"
                            width="400"
                            height="225"
                        />
                    </div>
                    <div class="card-content">
                        <p class="section-title"></p>
                    </div>
                </a>
            </article>
        </template>

        <section>
            <h1>{lang === "ar" ? "Ø£Ø­Ø¯Ø« Ù…Ø³Ø§Ø¨Ù‚Ø©" : "Latest Quiz"}</h1>

            <!-- Wrapper must exist for JS -->
            <section class="articles-grid">
                {
                    quizList?.length ? (
                        quizList.map((item) => (
                            <article class="article-card">
                                <a
                                    href={`/${langPrefix}quiz/${item.slug}`}
                                    class="card-link"
                                >
                                    <div class="card-image">
                                        <img
                                            src={item.landScapeBanner}
                                            alt={item.imageAlt || item.title}
                                            loading="lazy"
                                            width="400"
                                            height="225"
                                        />
                                    </div>
                                    <div class="card-content">
                                        <p class="section-title">
                                            {item.title}
                                        </p>
                                    </div>
                                </a>
                            </article>
                        ))
                    ) : (
                        <p class="no-articles">
                            {lang === "ar"
                                ? "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø± Ù…ØªØ§Ø­."
                                : "No quiz available."}
                        </p>
                    )
                }
                <div id="trigger"></div>
            </section>
        </section>

        <style>
            /* =========================
   INFINITE SCROLL TRIGGER
========================== */
            #trigger {
                width: 100%;
                height: 1px;
                grid-column: 1 / -1;
                visibility: hidden;
            }
            .section-title {
                font-size: 1.5rem;
                font-weight: 600;
            }
            /* =========================
   GRID
========================== */
            .articles-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 20px;
                padding: 16px;
            }

            /* =========================
   CARD (THEME NEUTRAL)
========================== */
            .article-card {
                background: var(--bg-surface);
                color: var(--text-primary);

                border-radius: 12px;
                overflow: hidden;

                box-shadow: var(--shadow-card);
                transition:
                    transform 0.3s ease,
                    box-shadow 0.3s ease;
            }

            .article-card:hover {
                transform: translateY(-6px);
            }

            /* =========================
   LINK RESET
========================== */
            .card-link {
                display: block;
                color: inherit;
                text-decoration: none;
            }

            /* =========================
   IMAGE
========================== */
            .card-image {
                position: relative;
                height: 0;
                padding-top: 56.25%; /* 16:9 */
                overflow: hidden;
            }

            .card-image img {
                position: absolute;
                inset: 0;

                width: 100%;
                height: 100%;
                object-fit: cover;

                transition: transform 0.5s ease;
            }

            .article-card:hover .card-image img {
                transform: scale(1.05);
            }

            /* =========================
   CONTENT
========================== */
            .card-content {
                padding: 12px 16px;
                background: var(--bg-surface); /* ðŸ”‘ fixes mobile white card */
            }

            .card-content h2 {
                font-size: 18px;
                line-height: 1.3;
                margin: 0 0 6px;

                color: var(--text-primary);
            }

            .card-content p {
                font-size: 14px;
                margin: 0;

                color: var(--text-secondary);
            }

            /* =========================
   EMPTY STATE
========================== */
            .no-articles {
                text-align: center;
                font-size: 16px;
                padding: 20px;

                color: var(--text-secondary);
            }

            /* =========================
   RTL SUPPORT
========================== */
            html[lang="ar"] .card-content h2,
            html[lang="ar"] .card-content p {
                text-align: right;
            }
        </style>
    </main>
</Layout>
<template id="article-card-template">
    <article class="article-card">
        <a class="card-link">
            <div class="card-image">
                <img loading="lazy" width="400" height="225" />
            </div>
            <div class="card-content">
                <p class="section-title"></p>
            </div>
        </a>
    </article>
</template>
<script define:vars={{ lang, langPrefix }}>
    if (typeof window !== "undefined") {
        let page = 1;
        let loading = false;

        const grid = document.querySelector(".articles-grid");
        const trigger = document.getElementById("trigger");
        const template = document.getElementById("article-card-template");

        // Safety check
        if (!grid || !trigger || !template) {
            console.error("Required elements missing");
            return;
        }

        const observer = new IntersectionObserver(async ([entry]) => {
            if (!entry.isIntersecting || loading) return;
            loading = true;

            const res = await fetch(`/api/quizapi?lang=${lang}&page=${page}`);
            const contentList = await res.json();

            if (!contentList.length) {
                ("No more articles.");
                return;
            }

            contentList.forEach((item) => {
                const clone = template.content.cloneNode(true);

                const link = clone.querySelector(".card-link");
                const img = clone.querySelector("img");
                const title = clone.querySelector("h2");

                link.href = `/${langPrefix}quiz/${item.slug}`;
                img.src = item.landScapeBanner;
                img.alt = item.imageAlt || item.title;
                if (title) {
                    title.textContent = item.title;
                }
                grid.insertBefore(clone, trigger);
                // grid.appendChild(clone);
                // grid.appendChild(trigger);
            });

            page += 1;
            loading = false;
        });

        observer.observe(trigger);
    }
</script>
