---
// ──────────────────────────────────────────────────────────────
//  Astro 4 + AMP Story Quiz – 100% Valid (Dec 2025 Spec)
// ──────────────────────────────────────────────────────────────
import { QuizStoryResponse } from "@lib/pojo/responsemodel/QuizStoryResponse";
import { QuizSlide } from "@lib/pojo/responsemodel/QuizSlide";
import { EndPointPaths } from "@lib/EndPointPaths";
import { RequestModel } from "@lib/pojo/requestmodel/RequestModel";
import { ApiResponse } from "@lib/pojo/responsemodel/ApiResponse";
import { ResponseModel } from "@lib/pojo/responsemodel/ResponseModel";
import { apiCalls, buildLangUrl } from "@lib/postmethodService";
import { checkForDecode } from "@lib/postmethodService";
import { metaConfig } from "@components/metaConfig";
import { getAppConfig } from "@lib/AppConfig";

const currentPath = Astro.url.pathname;
const { slug } = Astro.params;
const lang = currentPath.startsWith("/en") ? "en" : "ar";
const apiServer = getAppConfig();

export async function getQuizStory(lang: string, slug: string | undefined): Promise<QuizStoryResponse | null> {
  if (!slug) return null;
  try {
    const request = new RequestModel();
    request.lang = lang;
    request.slug = await checkForDecode(slug);
    const responseResult: ApiResponse = await apiCalls(request, EndPointPaths.getquizbyslug);
    if (responseResult.status === 0) {
      const response: ResponseModel = responseResult.data;
      if (response.statusCode === 0) {
        return response.respObject as QuizStoryResponse;
      }
    }
  } catch (err) {
    console.error("getQuizStory error:", err);
  }
  return null;
}

const quiz: QuizStoryResponse | null = await getQuizStory(lang, slug);
if (!quiz) {
  throw new Error("Quiz not found");
}

const baseUrl = await buildLangUrl(lang);
const canonicalUrl = `${baseUrl}quiz/${quiz.slug}`;
const siteName = metaConfig.siteName[lang];

const gradients = [
  ["#f3633fff", "#ef9b5bff"], ["#6A11CB", "#2575FC"], ["#F7971E", "#FFD200"], ["#2ac5a6ff", "#191654"],
  ["#0F2027", "#203A43"], ["#2C3E50", "#4CA1AF"], ["#4B6CB7", "#182848"], ["#FF416C", "#FF4B2B"],
  ["#1D4350", "#A43931"], ["#373B44", "#4286f4"]
];

function escAttr(s: string | undefined | null): string {
  if (!s) return "";
  return String(s).replace(/&/g, "&amp;").replace(/"/g, "&quot;").replace(/'/g, "&#39;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
}

function generateSlidesHtml(quiz: QuizStoryResponse): string {
  const backendEndpoint = `${apiServer.websiteUrl}quronfula/interact/submit`;
  const slides = (quiz.slides || []) as QuizSlide[];
  let html = `<amp-story-page id="banner" auto-advance-after="3s">
    <amp-story-grid-layer template="fill">
      <amp-img src="${escAttr(quiz.bannerImage)}" width="720" height="1280" layout="responsive" alt="${escAttr(quiz.title)}"></amp-img>
    </amp-story-grid-layer>
    <amp-story-grid-layer template="vertical" class="center-text">
      <h1 class="title-anim">${escAttr(quiz.title)}</h1>
    </amp-story-grid-layer>
  </amp-story-page>`;

  slides.forEach((slide, i) => {
    const [c1, c2] = gradients[i % gradients.length];
    const bgGradient = `/api/gradient?c1=${encodeURIComponent(c1)}&c2=${encodeURIComponent(c2)}`;
    const options = (slide.options || []).slice(0, 4);
    let optionsAttrs = "";
    options.forEach((opt, idx) => {
      const n = idx + 1;
      const correct = String(opt).trim() === String(slide.answer).trim() ? ` option-${n}-correct` : "";
      optionsAttrs += ` option-${n}-text="${escAttr(opt)}"${correct}`;
    });

    const quizId = `quiz-${Date.now()}-${i}`; // Unique ID
    html += `<amp-story-page id="q${i + 1}">
      <amp-story-grid-layer template="fill">
        <amp-img src="${bgGradient}" width="720" height="1280" layout="responsive" alt="background"></amp-img>
      </amp-story-grid-layer>
      <amp-story-grid-layer template="vertical" class="center-content">
        <div class="quiz-container">
          <h2 class="question">${escAttr(slide.question)}</h2>
          <amp-story-interactive-quiz id="${quizId}" endpoint="${backendEndpoint}" prompt-size="large" chip-style="transparent"${optionsAttrs}></amp-story-interactive-quiz>
        </div>
      </amp-story-grid-layer>
    </amp-story-page>`;
  });

  const defaultResults = [
    { category: lang === "en" ? "Beginner" : "مبتدئ", threshold: "0", text: lang === "en" ? "Good start!" : "بداية جيدة!", icon: "" },
    { category: lang === "en" ? "Intermediate" : "متوسط", threshold: "50", text: lang === "en" ? "Well done!" : "أحسنت!", icon: "" },
    { category: lang === "en" ? "Expert" : "خبير", threshold: "80", text: lang === "en" ? "Amazing!" : "رائع!", icon: "" },
    { category: lang === "en" ? "Master" : "محترف", threshold: "95", text: lang === "en" ? "You're a legend!" : "أنت أسطورة!", icon: "" }
  ];
  const results = quiz.result && quiz.result.length ? quiz.result : defaultResults;
  let resultsAttrs = "";
  results.slice(0, 4).forEach((r, i) => {
    const n = i + 1;
    resultsAttrs += ` option-${n}-results-category="${escAttr(r.category)}" option-${n}-text="${escAttr(r.text)}" option-${n}-results-threshold="${escAttr(r.threshold)}"`;
  });

  const resultTitle = lang === "en" ? "Your Result" : "نتيجتك";
  html += `<amp-story-page id="results">
    <amp-story-grid-layer template="fill">
      <amp-img src="/api/gradient?c1=${encodeURIComponent('#FF7E5F')}&c2=${encodeURIComponent('#FEB47B')}" width="720" height="1280" layout="responsive" alt="results bg"></amp-img>
    </amp-story-grid-layer>
    <amp-story-grid-layer template="vertical" class="center-content">
      <div class="result-container">
        <h3>${resultTitle}</h3>
        <amp-story-interactive-results id="final-results" prompt-text=""${resultsAttrs} style="--interactive-accent-color: #FFD700; --interactive-background-color: rgba(0,0,0,0.3);"></amp-story-interactive-results>
        <p class="share-text">${lang === "en" ? "Share your score or play again!" : "شارك نتيجتك أو العب مرة أخرى!"}</p>
      </div>
    </amp-story-grid-layer>
  </amp-story-page>`;

  return html;
}

const slidesHtml = generateSlidesHtml(quiz);
---

<!doctype html>
<html  lang={lang} dir={lang === "ar" ? "rtl" : "ltr"}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1" />
    <title>{quiz.metaTitle || quiz.title}</title>
    <meta name="description" content={quiz.metaDescription || quiz.title} />
    <meta property="og:title" content={quiz.metaTitle || quiz.title} />
    <meta property="og:description" content={quiz.metaDescription || quiz.title} />
    <meta property="og:image" content={quiz.landScapeBanner || quiz.bannerImage} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:type" content="article" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={quiz.metaTitle || quiz.title} />
    <meta name="twitter:description" content={quiz.metaDescription || quiz.title} />
    <meta name="twitter:image" content={quiz.landScapeBanner || quiz.bannerImage} />
    <meta name="amp-story-generator-name" content={siteName} />
    <meta name="amp-story-generator-version" content="1.0" />
    <link rel="canonical" href={canonicalUrl} />
    <link rel="preload" as="image" href={quiz.bannerImage} />
    <script async src="https://cdn.ampproject.org/v0.js"></script>
    <script async custom-element="amp-story" src="https://cdn.ampproject.org/v0/amp-story-1.0.js"></script>
    <script async custom-element="amp-story-interactive" src="https://cdn.ampproject.org/v0/amp-story-interactive-0.1.js"></script>
    <!-- EXACT 2025 BOILERPLATE - No spaces/newlines allowed -->
    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-o-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style>
    <noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;-o-animation:none;animation:none}</style></noscript>
    <!-- ONLY ONE amp-custom - Minified CSS -->
    <style amp-custom>html{font-family:system-ui,sans-serif}html[lang="ar"]{font-family:"Almarai",system-ui,sans-serif}@font-face{font-family:"Almarai";src:url("https://www.quronfula.com/fonts/Almarai-Regular.woff2") format("woff2");font-weight:400;font-display:swap}@font-face{font-family:"Almarai";src:url("https://www.quronfula.com/fonts/Almarai-Bold.woff2") format("woff2");font-weight:700;font-display:swap}.center-text,.center-content{align-items:center;justify-content:center;text-align:center;padding:32px}h1,h2,h3{color:#fff;margin:0;text-shadow:0 2px 10px rgba(0,0,0,.6)}h1{font-size:36px}.question{font-size:28px;line-height:1.3;margin-bottom:24px}.quiz-container,.result-container{width:100%;max-width:90%}.share-text{margin-top:24px;opacity:.9}.title-anim{opacity:0;animation:fadeIn 0.8s ease-out forwards}@keyframes fadeIn{to{opacity:1}}</style>
  </head>
  <body>
    <amp-story
      standalone
      title={quiz.title}
      publisher={quiz.author_name || "Quronfula"}
      publisher-logo-src="https://www.quronfula.com/logo.png"
      poster-portrait-src={quiz.bannerImage}
      poster-square-src={quiz.bannerImage}
      poster-landscape-src={quiz.landScapeBanner || quiz.bannerImage}
      set:html={slidesHtml}
    ></amp-story>
  </body>
</html>