---
import { QuizStoryResponse } from "@lib/pojo/responsemodel/QuizStoryResponse";
import { QuizSlide } from "@lib/pojo/responsemodel/QuizSlide";
import { EndPointPaths } from "@lib/EndPointPaths";
import { RequestModel } from "@lib/pojo/requestmodel/RequestModel";
import { ApiResponse } from "@lib/pojo/responsemodel/ApiResponse";
import { ResponseModel } from "@lib/pojo/responsemodel/ResponseModel";
import { apiCalls, buildLangUrl } from "@lib/postmethodService";
import { checkForDecode } from "@lib/postmethodService";
import { metaConfig } from "@components/metaConfig";

const currentPath = Astro.url.pathname;
const { slug } = Astro.params;
const lang = currentPath.startsWith("/en") ? "en" : "ar";
export async function getQuizStory(
    lang: string,
    slug: string,
): Promise<QuizStoryResponse | null> {
    try {
        const request = new RequestModel();
        request.lang = lang;
        request.slug = await checkForDecode(slug);
        const responseResult: ApiResponse = await apiCalls(
            request,
            EndPointPaths.getquizbyslug,
        );
        if (responseResult.status === 0) {
            const response: ResponseModel = responseResult.data;
            if (response.statusCode === 0) {
                const story: QuizStoryResponse = response.respObject;
                return story;
            }
        }
    } catch (err) {
        console.error("getQuizStory error:", err);
    }

    return null;
}
const quiz: QuizStoryResponse | null = await getQuizStory(lang, slug);
if (!quiz) {
    throw new Error("Quiz not found");
}
const baseUrl = await buildLangUrl(lang);
const canonicalUrl = baseUrl + "quiz/" + quiz.slug;
const siteName = metaConfig.siteName[lang];
const gradients = [
    ["#f3633fff", "#ef9b5bff"],
    ["#6A11CB", "#2575FC"],
    ["#F7971E", "#FFD200"],
    ["#2ac5a6ff", "#191654"],
    ["#0F2027", "#203A43"],
    ["#2C3E50", "#4CA1AF"],
    ["#4B6CB7", "#182848"],
    ["#FF416C", "#FF4B2B"],
    ["#1D4350", "#A43931"],
    ["#373B44", "#4286f4"],
];

// small helper to safely escape attribute values
function escAttr(s: string | undefined) {
    if (!s) return "";
    return String(s)
        .replace(/&/g, "&amp;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
}

// Build slidesHtml string (banner + question pages + results)
function generateSlidesHtml(quiz: QuizStoryResponse) {
    const slides = (quiz.slides || []) as QuizSlide[];

    // banner page (first)
    let html = `
<amp-story-page id="banner" auto-advance-after="2s">
  <amp-story-grid-layer template="fill">
    <amp-img src="${escAttr(quiz.bannerImage)}" layout="fill" object-fit="cover" alt="${escAttr(quiz.title)}"></amp-img>
  </amp-story-grid-layer>
  <amp-story-grid-layer template="vertical">
    <div style="display:flex;align-items:flex-end;justify-content:center;height:100%;padding:28px;box-sizing:border-box;">
      <h1 style="color:#fff;font-size:28px;text-align:center;margin:0;line-height:1.2;text-shadow:0 2px 8px rgba(0,0,0,0.6)">${escAttr(quiz.title)}</h1>
    </div>
  </amp-story-grid-layer>
</amp-story-page>
`;

    slides.forEach((slide, i) => {
        const [c1, c2] = gradients[i % gradients.length];
        // use gradient API (you can replace with any bg or image); encode colors for URL
        const bgImage = `/api/gradient?c1=${encodeURIComponent(c1)}&c2=${encodeURIComponent(c2)}`;

        // build option attributes for amp-story-interactive-quiz
        // amp expects attributes like: option-1-text="..." option-2-text="..." option-1-correct (flag)
        const optionsAttrs = (slide.options || [])
            .slice(0, 4)
            .map((opt, idx) => {
                const n = idx + 1;
                const optText = escAttr(opt);
                // mark correct option if it matches answer (string match)
                const isCorrect =
                    String(opt).trim() === String(slide.answer).trim()
                        ? `option-${n}-correct`
                        : "";
                return `option-${n}-text="${optText}" ${isCorrect}`;
            })
            .join(" ");

        html += `
<amp-story-page id="slide-${i}">
  <amp-story-grid-layer template="fill">
    <amp-img src="${escAttr(bgImage)}" layout="fill" object-fit="cover" alt="background"></amp-img>
  </amp-story-grid-layer>

  <amp-story-grid-layer template="vertical" class="quiz-center">
    <div class="quiz-wrapper" animate-in="scale-fade-up">
      <h2 class="quiz-question">${escAttr(slide.question)}</h2>

      <amp-story-interactive-quiz
        id="quiz-${i}"
        prompt-size="medium"
        chip-style="transparent"
        ${optionsAttrs}
      ></amp-story-interactive-quiz>

    </div>
  </amp-story-grid-layer>
</amp-story-page>
`;
    });

    // results page generation using quiz.result thresholds
    const results =
        quiz.result && quiz.result.length
            ? quiz.result
            : [
                  {
                      category: "Beginner",
                      threshold: "0",
                      text: "Good start",
                      icon: "üå∂Ô∏è",
                  },
                  {
                      category: "Intermediate",
                      threshold: "50",
                      text: "Nice job",
                      icon: "ü•ò",
                  },
                  {
                      category: "Expert",
                      threshold: "80",
                      text: "Great!",
                      icon: "üçΩÔ∏è",
                  },
                  {
                      category: "Master",
                      threshold: "95",
                      text: "Outstanding!",
                      icon: "üëë",
                  },
              ];

    // Prepare attributes for amp-story-interactive-results: option-1-results-category, option-1-text, option-1-results-threshold ...
    const resultsAttrs = results
        .slice(0, 4)
        .map((r, idx) => {
            const n = idx + 1;
            const cat = escAttr(r.category);
            const text = escAttr(r.text);
            const th = escAttr(r.threshold);
            return `
      option-${n}-results-category="${cat}"
      option-${n}-text="${text}"
      option-${n}-results-threshold="${th}"
    `;
        })
        .join("\n");

    const commonBg = `/api/gradient?c1=${encodeURIComponent("#FF7E5F")}&c2=${encodeURIComponent("#FEB47B")}`;
    const resltTxt = lang === "en" ? "Result" : "ŸÜÿ™Ÿäÿ¨ÿ™ŸÉ";
    const resultAct =
        lang === "en"
            ? "Share your result or try again to find out more."
            : "ÿ¥ÿßÿ±ŸÉ ŸÜÿ™Ÿäÿ¨ÿ™ŸÉ ÿ£Ÿà ÿ£ÿπÿØ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÑŸÖÿπÿ±ŸÅÿ© ÿßŸÑŸÖÿ≤ŸäÿØ.";
    html += `
<amp-story-page id="results-page">
  <amp-story-grid-layer template="fill">
    <amp-img src="${escAttr(commonBg)}"
             layout="fill"
             object-fit="cover"
             alt="results background">
    </amp-img>
  </amp-story-grid-layer>

  <!-- CENTERED CONTENT -->
  <amp-story-grid-layer template="vertical" class="quiz-center">
    <div class="result-wrapper">
      <h3>${resltTxt}</h3>

      <amp-story-interactive-results
        id="results-1"
        prompt-text=""
        ${resultsAttrs}
        style="
          --interactive-background-color: rgba(255,255,255,0.06);
          --interactive-font-color: #fff;
          --interactive-border-radius: 16px;
        ">
      </amp-story-interactive-results>

      <p>${resultAct}</p>
    </div>
  </amp-story-grid-layer>
</amp-story-page>
`;

    return html;
}

const slidesHtml = generateSlidesHtml(quiz);
---

<!doctype html>
<html ‚ö° lang={lang} dir={lang === "ar" ? "rtl" : "ltr"}>
    <head>
        <meta charset="utf-8" />
        <meta
            name="viewport"
            content="width=device-width,minimum-scale=1,initial-scale=1"
        />
        <title>{quiz.metaTitle || quiz.title}</title>
        <meta name="description" content={quiz.metaDescription || quiz.title} />
        <meta name="robots" content="max-image-preview:large" />
        <meta property="title" content={quiz.metaTitle} />
        <meta property="keywords" name={quiz.keywords} />
        <meta property="quiz_keywords" name={quiz.keywords} />
        <meta property="og:title" content={quiz.metaTitle} />
        <meta property="og:image" content={quiz.landScapeBanner} />
        <meta property="og:url" content={canonicalUrl} />
        <meta property="og:type" content="quiz" />
        <meta property="og:description" content={quiz.metaDescription} />
        <meta property="og:published_time" content={new Date(quiz.publishDate).toISOString()} />
        <meta property="og:modified_time" content={new Date(quiz.publishDate).toISOString()} />
        <meta property="og:site_name" content={siteName} />
        <meta name="twitter:title" content={quiz.metaTitle} />
        <meta name="twitter:description" content={quiz.metaDescription} />
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:image" content={quiz.landScapeBanner} />
        <meta name="amp-story-generator-name" content={siteName} />
        <meta name="amp-story-generator-version" content="0.1" />
        <link rel="canonical" href={canonicalUrl} />
        <link href={quiz.bannerImage} rel="preload" as="image" />
        <link
            rel="icon"
            type="image/png"
            sizes="32x32"
            href="https://www.quronfula.com/icons/favicon-32x32.png"
        />
        <link
            rel="apple-touch-icon"
            sizes="180x180"
            href="https://www.quronfula.com/icons/apple-icon-180x180.png"
        />
        <link
            rel="shortcut icon"
            href="https://www.quronfula.com/icons/favicon.ico"
            type="image/x-icon"
        />
        <link
            href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap"
            rel="stylesheet"
        />

        <!-- AMP core + story + interactive -->
        <script async src="https://cdn.ampproject.org/v0.js"></script>
        <script
            async
            custom-element="amp-story"
            src="https://cdn.ampproject.org/v0/amp-story-1.0.js"></script>
        <script
            async
            custom-element="amp-story-interactive"
            src="https://cdn.ampproject.org/v0/amp-story-interactive-0.1.js"
        ></script>

        <!-- AMP boilerplate (required) -->
        <style amp-boilerplate>
            body {
                -webkit-animation: -amp-start 8s steps(1, end) 0s 1 normal both;
                animation: -amp-start 8s steps(1, end) 0s 1 normal both;
            }
            @-webkit-keyframes -amp-start {
                from {
                    visibility: hidden;
                }
                to {
                    visibility: visible;
                }
            }
            @keyframes -amp-start {
                from {
                    visibility: hidden;
                }
                to {
                    visibility: visible;
                }
            }
        </style>
        <noscript
            ><style amp-boilerplate>
                body {
                    -webkit-animation: none;
                    animation: none;
                }
            </style></noscript
        >

        <style amp-custom>
            /* Minimal styles for story layers */
            html {
                font-family: sans-serif;
            }

            html[lang="ar"] {
                font-family: "QFArabic", sans-serif;
            }

            @font-face {
                font-family: "QFArabic";
                src: url("https://www.quronfula.com/fonts/Almarai-Regular.woff2") format("woff2");
                font-weight: 400;
                font-style: normal;
                font-display: swap;
                /* CLS safe */
            }

            @font-face {
                font-family: "QFArabic";
                src: url("https://www.quronfula.com/fonts/Almarai-Bold.woff2") format("woff2");
                font-weight: 700;
                font-style: normal;
                font-display: swap;
            }
            body {
                margin: 0;
                color: white;
            }

            .quiz-wrapper {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                width: 100%;
                max-width: 90%;
                margin: 0 auto;
                text-align: center;
                padding: 20px;
                box-sizing: border-box;
                color: #fff;
            }
            .quiz-question {
                font-size: 28px;
                line-height: 1.2;
                font-weight: 700;
                margin: 0 0 18px;
                text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
            }
            .quiz-center {
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 0 24px;
            }

            .result-wrapper {
                text-align: center;
                max-width: 320px;
                width: 100%;
            }

            .result-wrapper h3 {
                font-size: 26px;
                font-weight: 700;
                color: #fff;
                margin-bottom: 12px;
            }

            .result-wrapper p {
                font-size: 16px;
                line-height: 1.5;
                color: rgba(255, 255, 255, 0.85);
                margin-top: 18px;
            }
            /* responsive tweaks */
            @media (max-width: 480px) {
                .quiz-question {
                    font-size: 20px;
                }
            }
        </style>
    </head>

    <body>
        <!-- NOTE: set:html on amp-story injects raw amp-story-page children directly (no wrapper) -->
        <amp-story
            standalone
            title={quiz.title}
            publisher={quiz.author_name || "Quronfula"}
            publisher-logo-src={"/logo.png"}
            poster-portrait-src={quiz.bannerImage}
            set:html={slidesHtml}
        />
    </body>
</html>
