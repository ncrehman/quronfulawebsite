---
import {
    apiCalls,
    buildLangUrl,
    generateBreadcrumb,
    generateItemList,
} from "@lib/postmethodService";
import { EndPointPaths } from "@lib/EndPointPaths";
import { RequestModel } from "@lib/pojo/requestmodel/RequestModel";
import { ArticleResponse } from "@lib/pojo/responsemodel/ArticleResponse";
import Layout from "@layouts/Layout.astro";
import SEO from "@components/SEO.astro";
import { metaConfig } from "@components/metaConfig";
import { getAppConfig } from "@lib/AppConfig";
import { checkForDecode } from "@lib/postmethodService";
import { ApiResponse } from "@lib/pojo/responsemodel/ApiResponse";
import { getLangPrefix } from "@lib/postmethodService";
import type { SubCategoryResponse } from "@lib/pojo/responsemodel/SubCategoryResponse";
import AdPlaceholder from "@components/AdPlaceholder.astro";
import { Image } from "astro:assets";

const { slug = "", catslug = "", lang = "ar" } = Astro.props;
const pageParam = Astro.url.searchParams.get("page");
const currentPage = pageParam ? parseInt(pageParam, 10) : 1;

const limit = 10;
const offset = (currentPage - 1) * limit;

async function getSubCategory(
    lang: string,
    slug: string,
): Promise<SubCategoryResponse | null> {
    const request = new RequestModel();
    request.lang = lang;
    request.slug = slug;
    request.extraVariable = "article";
    const response: ApiResponse = await apiCalls(
        request,
        EndPointPaths.getsubcategorybyslugtopic,
    );
    if (response.status === 0 && response.data.statusCode === 0) {
        return response.data.respObject;
    }
    return null;
}
async function getArticleList(
    lang: string,
    subCatslug: string,
    limit: number,
    offset: number,
): Promise<ArticleResponse[]> {
    const request = new RequestModel();
    request.lang = lang;
    request.limit = limit;
    request.offset = offset;
    request.slug = await checkForDecode(subCatslug);
    const response = await apiCalls(
        request,
        EndPointPaths.getarticlesbysubcategoryslug,
    );
    if (response.status === 0 && response.data.statusCode === 0) {
        return response.data.respList || [];
    }
    return [];
}

const langPrefix = await getLangPrefix(lang);
const apiServer = await getAppConfig();
const baseUrl = await buildLangUrl(lang);
const siteName = metaConfig.siteName[lang];
const jsonLd = [];
const decodedCatslug = await checkForDecode(catslug);
const decodedSubCatSlug = await checkForDecode(slug);
let subCategoryObj = await getSubCategory(lang, decodedSubCatSlug);
if (!subCategoryObj) {
    subCategoryObj = null;
}
const [articles] = await Promise.all([
    getArticleList(lang, decodedSubCatSlug, limit, offset),
]);
let canonicalUrl: string = "";
if (!!subCategoryObj) {
    canonicalUrl =
        currentPage === 1
            ? `${baseUrl}category/${subCategoryObj.cat_slug}/${subCategoryObj.slug}`
            : `${baseUrl}category/${subCategoryObj.cat_slug}/${subCategoryObj.slug}?page=${currentPage}`;

    const breadCrumb = generateBreadcrumb("Home Page Breadcrumbs", [
        {
            name: lang === "ar" ? "الرئيسية" : "Home",
            url: baseUrl,
        },
        {
            name: lang === "ar" ? "فئة" : "Category",
            url: baseUrl + "category/",
        },
        {
            name: subCategoryObj.cat_name,
            url: baseUrl + "category/" + subCategoryObj.cat_slug,
        },
        {
            name: subCategoryObj.title,
            url:
                baseUrl +
                "category/" +
                subCategoryObj.cat_slug +
                "/" +
                subCategoryObj.slug,
        },
    ]);
    jsonLd.push(breadCrumb);
}
if (articles) {
    const itemListJson = generateItemList({
        name: subCategoryObj.title + " Article Collection",
        description:
            "Explore our collection of in-depth articles covering culture, trends, lifestyle, creativity, and modern storytelling. Updated regularly with fresh insights",
        baseUrl: baseUrl + "article/",
        listUrl: baseUrl + "article/",
        items: articles.map((a: ArticleResponse) => ({
            title: a.title,
            slug: a.slug,
            image: a.landScapeBanner,
            authorName: a.authorName,
            authorSlug: a.authorSlug,
            type: "Article",
        })),
        creatorName: siteName,
        creatorUrl: apiServer.websiteUrl,
    });
    jsonLd.push(itemListJson);
}
---

{
    subCategoryObj && (
        <SEO
            title={subCategoryObj.metaTitle}
            description={subCategoryObj.metaDescription}
            image={subCategoryObj.bannerImage}
            url={canonicalUrl}
            lang={lang}
            canonical={canonicalUrl}
            noindex={false}
            type={"WebSite"}
            jsonLd={jsonLd}
        />
    )
}

<Layout>
    <main>
        <>
            <section class="category-hero">
                <div
                    class="category-hero-bg"
                    style={`background-image: url('${subCategoryObj.bannerImage}')`}
                >
                </div>

                <div class="category-hero-content">
                    <h1 class="category-title">{subCategoryObj.title}</h1>

                    <p class="category-description">
                        {subCategoryObj.description}
                    </p>
                </div>
                <div class="category-wave"></div>
            </section>
            <section>
                <div id="container-7538bd9c37b3bc6235c127a4b18d2e6c"></div>
            </section>
            <section>
                {
                    articles ? (
                        <section>
                            <section class="articles-grid">
                                {articles?.length ? (
                                    articles.map((item) => (
                                        <article class="article-card">
                                            <a
                                                href={`/${langPrefix}article/${item.slug}`}
                                                class="card-link"
                                            >
                                                <div class="card-image">
                                                    <Image
                                                        src={
                                                            item.landScapeBanner
                                                        }
                                                        alt={
                                                            item.imageAlt ||
                                                            item.title
                                                        }
                                                        loading="lazy"
                                                        width="400"
                                                        height="225"
                                                    />
                                                </div>
                                                <div class="card-content">
                                                    <h2>{item.title}</h2>
                                                </div>
                                            </a>
                                        </article>
                                    ))
                                ) : (
                                    <p class="no-articles">
                                        {lang === "ar"
                                            ? "لا توجد مقالات."
                                            : "No articles available."}
                                    </p>
                                )}
                            </section>
                            <section>
                                <AdPlaceholder
                                    calledFrom="subcategory"
                                    slot="2578599202"
                                    layout="display"
                                    format="auto"
                                    display="block"
                                    textAlign="center"
                                    height={200}
                                    width="100%"
                                />
                            </section>
                            <nav class="pagination">
                                {currentPage > 1 && (
                                    <a
                                        href={`/${langPrefix}category/${subCategoryObj.cat_slug}/${subCategoryObj.slug}?page=${currentPage - 1}`}
                                        rel="prev"
                                        class="pagination-btn"
                                    >
                                        ←{" "}
                                        {lang === "ar" ? "السابق" : "Previous"}
                                    </a>
                                )}

                                <span class="page-number">
                                    {lang === "ar"
                                        ? `صفحة ${currentPage}`
                                        : `Page ${currentPage}`}
                                </span>

                                {articles.length === limit && (
                                    <a
                                        href={`/${langPrefix}category/${subCategoryObj.cat_slug}/${subCategoryObj.slug}?page=${currentPage + 1}`}
                                        rel="next"
                                        class="pagination-btn"
                                    >
                                        {lang === "ar" ? "التالي" : "Next"} →
                                    </a>
                                )}
                            </nav>
                        </section>
                    ) : null
                }
            </section>
            <style>
                .category-hero {
                    position: relative;
                    min-height: 40vh;
                    height: 50vh;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    text-align: center;
                    border-radius: 10px;
                    overflow: hidden;
                }

                .category-hero-bg {
                    position: absolute;
                    inset: 0;
                    background-size: cover;
                    background-position: center;
                    z-index: 0;
                }

                /* Dark gradient overlay */
                .category-hero-bg::after {
                    content: "";
                    position: absolute;
                    inset: 0;
                    background: linear-gradient(
                        to bottom,
                        rgba(0, 0, 0, 0.55),
                        rgba(0, 0, 0, 0.75)
                    );
                }

                .category-hero-content {
                    position: relative;
                    z-index: 2;
                    max-width: 1000px;
                    padding: 2rem 1rem;
                    color: #fff;
                }

                .category-title {
                    font-size: clamp(2.2rem, 4vw, 2.8rem);
                    font-weight: 600;
                    line-height: 1.1;
                    margin-bottom: 1.5rem;
                    letter-spacing: -0.03em;
                    text-shadow: 0 6px 20px rgba(0, 0, 0, 0.5);
                }

                .category-description {
                    font-size: clamp(1.15rem, 2.5vw, 1.5rem);
                    line-height: 1.75;
                    max-width: 720px;
                    margin: 0 auto 2.5rem;
                    color: rgba(255, 255, 255, 0.92);
                    text-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
                }

                /* ============================
   MOBILE FIX (≤ 768px)
============================ */
                @media (max-width: 768px) {
                    .category-hero {
                        min-height: 25vh;
                        height: 28vh;
                        border-radius: 10px; /* full-bleed on mobile looks better */
                    }

                    .category-hero-bg {
                        background-position: center top;
                    }

                    .category-hero-content {
                        padding: 1.5rem 1rem;
                    }

                    .category-title {
                        font-size: 1.8rem;
                        font-weight: 700;
                        margin-bottom: 1rem;
                    }

                    .category-description {
                        font-size: 1rem;
                        line-height: 1.6;
                        margin-bottom: 1.5rem;
                    }
                }

                /* ============================
   VERY SMALL SCREENS (≤ 480px)
============================ */
                @media (max-width: 480px) {
                    .category-hero {
                        min-height: 20vh;
                        height: 25vh;
                        border-radius: 10px;
                    }

                    .category-title {
                        font-size: 1.6rem;
                    }

                    .category-description {
                        font-size: 0.95rem;
                    }
                }
                .pagination {
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    gap: 1.5rem;
                    margin: 3rem 0;
                }

                .pagination-btn {
                    padding: 0.6rem 1.4rem;
                    border-radius: 9999px;
                    text-decoration: none;
                    font-weight: 600;
                    border: 1px solid #ccc;
                    color: #333;
                    background: #fff;
                }

                .pagination-btn:hover {
                    background: #f5f5f5;
                }

                .page-number {
                    font-weight: 700;
                }
                .articles-grid {
                    display: grid;
                    grid-template-columns: repeat(
                        auto-fill,
                        minmax(300px, 1fr)
                    );
                    gap: 20px;
                    padding: 16px;
                }

                .article-card {
                    background: #fff;
                    border-radius: 12px;
                    overflow: hidden;
                    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
                    transition:
                        transform 0.3s ease,
                        box-shadow 0.3s ease;
                }

                .article-card:hover {
                    transform: translateY(-6px);
                    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
                }

                .card-link {
                    display: block;
                    color: inherit;
                    text-decoration: none;
                }

                .card-image {
                    overflow: hidden;
                    height: 0;
                    padding-top: 56.25%; /* 16:9 aspect ratio */
                    position: relative;
                }

                .card-image img {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    object-fit: cover;
                    transition: transform 0.5s ease;
                }

                .article-card:hover .card-image img {
                    transform: scale(1.05);
                }

                .card-content {
                    padding: 12px 16px;
                }

                .card-content h2 {
                    font-size: 18px;
                    margin: 0 0 8px;
                    line-height: 1.3;
                }

                .card-content p {
                    font-size: 14px;
                    color: #555;
                    margin: 0;
                }

                .no-articles {
                    text-align: center;
                    font-size: 16px;
                    padding: 20px;
                    color: #777;
                }

                /* RTL support */
                html[lang="ar"] .card-content h2,
                html[lang="ar"] .card-content p {
                    text-align: right;
                }
            </style>
        </>
    </main>
</Layout>
