---
import {
    apiCalls,
    buildLangUrl,
    generateBreadcrumb,
    generateItemList,
} from "@lib/postmethodService";
import { EndPointPaths } from "@lib/EndPointPaths";
import { RequestModel } from "@lib/pojo/requestmodel/RequestModel";
import { ArticleResponse } from "@lib/pojo/responsemodel/ArticleResponse";
import Layout from "@layouts/Layout.astro";
import SEO from "@components/SEO.astro";
import { metaConfig } from "@components/metaConfig";
import { getAppConfig } from "@lib/AppConfig";
import { checkForDecode } from "@lib/postmethodService";
import { ApiResponse } from "@lib/pojo/responsemodel/ApiResponse";
import { getLangPrefix } from "@lib/postmethodService";
import type { SubCategoryResponse } from "@lib/pojo/responsemodel/SubCategoryResponse";

interface Params {
    lang: string;
    catslug: string;
    subcatslug: string;
}
const { slug = "", catslug = "", lang = "ar" } = Astro.props;

async function getSubCategory(
    lang: string,
    slug: string,
): Promise<SubCategoryResponse | null> {
    const request = new RequestModel();
    request.lang = lang;
    request.slug = slug;
    request.extraVariable = "article";
    const response:ApiResponse = await apiCalls(
        request,
        EndPointPaths.getsubcategorybyslugtopic,
    );
    if (response.status === 0 && response.data.statusCode === 0) {
        return response.data.respObject;
    }
    return null;
}
async function getArticleList(
    lang: string,
    subCatslug: string,
): Promise<ArticleResponse[]> {
    const request = new RequestModel();
    request.lang = lang;
    request.limit = 5;
    request.offset = 0;
    request.slug = await checkForDecode(subCatslug);
    const response = await apiCalls(
        request,
        EndPointPaths.getarticlesbysubcategoryslug,
    );
    if (response.status === 0 && response.data.statusCode === 0) {
        return response.data.respList || [];
    }
    return [];
}

const langPrefix = getLangPrefix(lang);
const apiServer = getAppConfig();
const baseUrl = await buildLangUrl(lang);
const siteName = metaConfig.siteName[lang];
const jsonLd = [];
const decodedCatslug = await checkForDecode(catslug);
const decodedSubCatSlug = await checkForDecode(slug);
const [subCategoryObj, articles] = await Promise.all([
    getSubCategory(lang, decodedSubCatSlug),
    getArticleList(lang, decodedSubCatSlug),
]);
let canonicalUrl: string = null;
if (!!subCategoryObj) {
    canonicalUrl =
        baseUrl +
        "category/" +
        subCategoryObj.cat_slug +
        "/" +
        subCategoryObj.slug;
    const breadCrumb = generateBreadcrumb("Home Page Breadcrumbs", [
        {
            name: lang === "ar" ? "الرئيسية" : "Home",
            url: baseUrl,
        },
        {
            name: lang === "ar" ? "فئة" : "Category",
            url: baseUrl + "category/",
        },
        {
            name: subCategoryObj.cat_name,
            url: baseUrl + "category/" + subCategoryObj.cat_slug,
        },
        {
            name: subCategoryObj.title,
            url:
                baseUrl +
                "category/" +
                subCategoryObj.cat_slug +
                "/" +
                subCategoryObj.slug,
        },
    ]);
    jsonLd.push(breadCrumb);
}
if (articles) {
    const itemListJson = generateItemList({
        name: subCategoryObj.title + " Article Collection",
        description:
            "Explore our collection of in-depth articles covering culture, trends, lifestyle, creativity, and modern storytelling. Updated regularly with fresh insights and inspiration.",
        baseUrl: baseUrl + "article/",
        listUrl: baseUrl + "article/",
        items: articles.map((a: ArticleResponse) => ({
            title: a.title,
            slug: a.slug,
            image: a.landScapeBanner,
            authorName: a.authorName,
            authorSlug: a.authorSlug,
            type: "Article",
        })),
        creatorName: siteName,
        creatorUrl: apiServer.websiteUrl,
    });
    jsonLd.push(itemListJson);
}
---

{
    subCategoryObj && (
        <SEO
            title={subCategoryObj.metaTitle}
            description={subCategoryObj.metaDescription}
            image={subCategoryObj.bannerImage}
            url={canonicalUrl}
            lang={lang}
            canonical={canonicalUrl}
            noindex={false}
            type={"WebSite"}
            jsonLd={jsonLd}
        />
    )
}

<Layout>
    <main>
        <>
            <!-- HERO BANNER – Pure Inline CSS (Arabic Version) -->
            <section
                style="
    position: relative;
    min-height: 70vh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    overflow: hidden;
  "
            >
                <!-- Background Image + Dark Overlay -->
                <div
                    style={`
      position: absolute;
      inset: 0;
      background-image: url('${subCategoryObj.bannerImage}');
      background-size: cover;
      background-position: center;
      filter: brightness(0.4);
                   `}
                >
                </div>

                <!-- Content -->
                <div
                    style="position: relative; z-index: 2; max-width: 900px; padding: 2rem;"
                >
                    <h1
                        style="
        font-size: 4.5rem;
        font-weight: 900;
        margin-bottom: 1.5rem;
        text-shadow: 0 10px 30px rgba(0,0,0,0.6);
        line-height: 1.1;
        letter-spacing: -1px;
      "
                    >
                        {subCategoryObj.title}
                    </h1>

                    <p
                        style="
        font-size: 1.5rem;
        opacity: 0.95;
        max-width: 700px;
        margin: 0 auto 2.5rem;
        line-height: 1.7;
        font-weight: 300;
      "
                    >
                        {subCategoryObj.description}
                    </p>
                </div>

                <!-- Optional subtle wave at bottom -->
                <div
                    style="
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 120px;
      background: white;
      clip-path: ellipse(150% 100% at 50% 100%);
    "
                >
                </div>
            </section>

            <section>
                {
                    articles ? (
                        <section>
                            <section class="articles-grid">
                                {articles?.length ? (
                                    articles.map((item) => (
                                        <article class="article-card">
                                            <a
                                                href={`/${langPrefix}article/${item.slug}`}
                                                class="card-link"
                                            >
                                                <div class="card-image">
                                                    <img
                                                        src={
                                                            item.landScapeBanner
                                                        }
                                                        alt={
                                                            item.imageAlt ||
                                                            item.title
                                                        }
                                                        loading="lazy"
                                                        width="400"
                                                        height="225"
                                                    />
                                                </div>
                                                <div class="card-content">
                                                    <h2>{item.title}</h2>
                                                </div>
                                            </a>
                                        </article>
                                    ))
                                ) : (
                                    <p class="no-articles">
                                        {lang === "ar"
                                            ? "لا توجد مقالات."
                                            : "No articles available."}
                                    </p>
                                )}
                            </section>
                        </section>
                    ) : null
                }
            </section>
            <style>
                .articles-grid {
                    display: grid;
                    grid-template-columns: repeat(
                        auto-fill,
                        minmax(300px, 1fr)
                    );
                    gap: 20px;
                    padding: 16px;
                }

                .article-card {
                    background: #fff;
                    border-radius: 12px;
                    overflow: hidden;
                    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
                    transition:
                        transform 0.3s ease,
                        box-shadow 0.3s ease;
                }

                .article-card:hover {
                    transform: translateY(-6px);
                    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
                }

                .card-link {
                    display: block;
                    color: inherit;
                    text-decoration: none;
                }

                .card-image {
                    overflow: hidden;
                    height: 0;
                    padding-top: 56.25%; /* 16:9 aspect ratio */
                    position: relative;
                }

                .card-image img {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    object-fit: cover;
                    transition: transform 0.5s ease;
                }

                .article-card:hover .card-image img {
                    transform: scale(1.05);
                }

                .card-content {
                    padding: 12px 16px;
                }

                .card-content h2 {
                    font-size: 18px;
                    margin: 0 0 8px;
                    line-height: 1.3;
                }

                .card-content p {
                    font-size: 14px;
                    color: #555;
                    margin: 0;
                }

                .no-articles {
                    text-align: center;
                    font-size: 16px;
                    padding: 20px;
                    color: #777;
                }

                /* RTL support */
                html[lang="ar"] .card-content h2,
                html[lang="ar"] .card-content p {
                    text-align: right;
                }
            </style>
        </>
    </main>
</Layout>
