---
import {
    apiCalls,
    buildLangUrl,
    generateBreadcrumb,
    generateItemList,
} from "@lib/postmethodService";
import { EndPointPaths } from "@lib/EndPointPaths";
import { RequestModel } from "@lib/pojo/requestmodel/RequestModel";
import { ArticleResponse } from "@lib/pojo/responsemodel/ArticleResponse";
import HeroFeatured from "@components/commonHome/HeroFeatured.astro";
import Layout from "@layouts/Layout.astro";
import SEO from "@components/SEO.astro";
import { metaConfig } from "@components/metaConfig";
import { getAppConfig } from "@lib/AppConfig";
import { WebStoryResponse } from "@lib/pojo/responsemodel/WebStoryResponse";
import { QuizStoryResponse } from "@lib/pojo/responsemodel/QuizStoryResponse";
import { checkForDecode } from "@lib/postmethodService";
import { ApiResponse } from "@lib/pojo/responsemodel/ApiResponse";
import { ResponseModel } from "@lib/pojo/responsemodel/ResponseModel";
import { getLangPrefix } from "@lib/postmethodService";
import type { CatResponse } from "@lib/pojo/responsemodel/CatResponse";

// const lang = Astro.url.pathname.startsWith("/en") ? "en" : "ar";
const { lang } = Astro.props;

// Fetch homepage data or articles specific to home page

const categoryCache: Map<string, CatResponse[]> = new Map();

async function getCategory(lang: string): Promise<CatResponse[] | null> {
    const cacheKey = `${lang}_${"category"}`;
    if (categoryCache.has(cacheKey)) return categoryCache.get(cacheKey)!;

    const request = new RequestModel();
    request.lang = lang;

    try {
        const response: ApiResponse = await apiCalls(
            request,
            EndPointPaths.getallcategories,
        );
        if (response.status !== 0) return null;
        const resp: ResponseModel = response.data;
        if (resp.statusCode == 0) {
            const catData: Array<CatResponse> = resp.respList;
            categoryCache.set(cacheKey, catData);
            return catData;
        } else {
            return null;
        }
    } catch (error) {
        console.error("Error fetching categories:", error);
        return null;
    }
}

const categories: Array<CatResponse> = await getCategory(lang);

const langPrefix = getLangPrefix(lang);
const apiServer = getAppConfig();
const baseUrl = await buildLangUrl(lang);
const canonicalUrl = baseUrl+'category';
const siteName = metaConfig.siteName[lang];
let title = "";
let description = "";
if (lang === "ar") {
    title = "التصنيفات - مدونة سطور | مقالات تقنية وبرمجة بالعربية";
    description =
        "استكشف مقالات معمقة عن الثقافة، الاتجاهات، أسلوب الحياة، الإبداع، والسرد الحديث مع رؤى ملهمة تُحدّث باستمرار.";
} else {
    title = "Categories - Sutoor Blog | Tech, Programming & Web Development";
    description =
        "Explore in-depth articles on culture, trends, lifestyle, creativity, and modern storytelling—fresh insights and inspiration, updated regularly.";
}

const jsonLd = [];

const breadCrumb = generateBreadcrumb("Home Page Breadcrumbs", [
    {
        name: lang === "ar" ? "الرئيسية" : "Home",
        url: baseUrl,
    },
    {
        name: lang === "ar" ? "فئة" : "Category",
        url: baseUrl + "category/",
    },
]);
jsonLd.push(breadCrumb);

if (categories) {
    const itemListJson = generateItemList({
        name: "Quronfula Categories Collection",
        description:description,
        baseUrl: baseUrl + "category/",
        listUrl: baseUrl + "category/",
        items: categories.map((a) => ({
            title: a.title,
            slug: a.slug,
            image: a.bannerImage,
            type: "Category",
        })),
        creatorName: siteName,
        creatorUrl: apiServer.websiteUrl,
    });
    jsonLd.push(itemListJson);
}
---

<SEO
    title={title}
    description={description}
    image={baseUrl + "categoryog.webp"}
    url={canonicalUrl}
    lang={lang}
    canonical={canonicalUrl}
    noindex={false}
    type={"WebSite"}
    jsonLd={jsonLd}
/>
<Layout>
  <main>
    <>
      {categories ? (
        <section>
          <h1 class="page-title">
            {lang === "ar" ? "فئات" : "Categories"}
          </h1>

          <section class="articles-grid">
            {categories.length ? (
              categories.map((item: CatResponse) => (
                <article class="article-card">
                  <a
                    href={`/${langPrefix}category/${item.slug}`}
                    class="card-link"
                  >
                    <div class="card-image">
                      <img
                        src={item.bannerImage}
                        alt={item.imageAlt || item.title}
                        loading="lazy"
                        width="400"
                        height="225"
                      />
                    </div>

                    <div class="card-content">
                      <h2>{item.title}</h2>
                    </div>
                  </a>
                </article>
              ))
            ) : (
              <p class="no-articles">
                {lang === "ar"
                  ? "لا توجد فئة متاحة."
                  : "No category available."}
              </p>
            )}
          </section>
        </section>
      ) : null}

      <style>
        /* =========================
           Layout & Grid
        ========================== */
        .page-title {
          display: flex;
          justify-content: center;
          margin: 2rem 0;
        }

        .articles-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
          gap: 20px;
          padding: 16px;
        }

        /* =========================
           Cards (Theme Neutral)
        ========================== */
        .article-card {
          border-radius: 12px;
          overflow: hidden;
          transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .article-card:hover {
          transform: translateY(-6px);
        }

        .card-link {
          display: block;
          color: inherit;
          text-decoration: none;
        }

        /* =========================
           Image
        ========================== */
        .card-image {
          position: relative;
          height: 0;
          padding-top: 56.25%; /* 16:9 */
          overflow: hidden;
        }

        .card-image img {
          position: absolute;
          inset: 0;
          width: 100%;
          height: 100%;
          object-fit: cover;
          transition: transform 0.5s ease;
        }

        .article-card:hover .card-image img {
          transform: scale(1.05);
        }

        /* =========================
           Content
        ========================== */
        .card-content {
          padding: 12px 16px;
          display: flex;
          justify-content: center;
          text-align: center;
          background: inherit;
        }

        .card-content h2 {
          font-size: 18px;
          margin: 0;
          line-height: 1.3;
        }

        .no-articles {
          text-align: center;
          font-size: 16px;
          padding: 20px;
        }

        /* =========================
           RTL Support
        ========================== */
        html[lang="ar"] .card-content h2 {
          text-align: right;
        }
      </style>
    </>
  </main>
</Layout>
