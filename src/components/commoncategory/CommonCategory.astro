---
import {
    apiCalls,
    buildLangUrl,
    detectDevice,
    generateBreadcrumb,
    generateItemList,
} from "@lib/postmethodService";
import { EndPointPaths } from "@lib/EndPointPaths";
import { RequestModel } from "@lib/pojo/requestmodel/RequestModel";
import { ArticleResponse } from "@lib/pojo/responsemodel/ArticleResponse";
import Layout from "@layouts/Layout.astro";
import SEO from "@components/SEO.astro";
import { metaConfig } from "@components/metaConfig";
import { getAppConfig } from "@lib/AppConfig";
import { checkForDecode } from "@lib/postmethodService";
import { ApiResponse } from "@lib/pojo/responsemodel/ApiResponse";
import { ResponseModel } from "@lib/pojo/responsemodel/ResponseModel";
import { getLangPrefix } from "@lib/postmethodService";
import type { CatResponse } from "@lib/pojo/responsemodel/CatResponse";
import type { CategoryResponse } from "@lib/pojo/responsemodel/CategoryResponse";
import type { SubCategoryResponse } from "@lib/pojo/responsemodel/SubCategoryResponse";
import { loadContent } from "@lib/contentLoader";
import AdPlaceholder from "@components/AdPlaceholder.astro";
import { Image } from "astro:assets";
import { generateSeo } from "@lib/MetaDescriptionUtil";
import type { MetaObject } from "@lib/MetaObject";

interface Props {
    catslug: string;
    lang: string;
}
const { catslug = "", lang = "ar" } = Astro.props;

const pageParam = Astro.url.searchParams.get("page");
const currentPage = pageParam ? parseInt(pageParam, 10) : 1;
const limit = 10;
const offset = (currentPage - 1) * limit;

const categoryCache: Map<string, CatResponse[]> = new Map();

async function getCategory(
    lang: string,
    catslug: string,
): Promise<CategoryResponse | null> {
    const request = new RequestModel();
    request.lang = lang;
    request.slug = await checkForDecode(catslug);
    try {
        const response: ApiResponse = await apiCalls(
            request,
            EndPointPaths.getcategorybyslug,
        );
        if (response.status !== 0) return null;
        const resp: ResponseModel = response.data;
        return resp.statusCode === 0 ? resp.respObject : null;
    } catch (error) {
        console.error("Error fetching category:", error);
        return null;
    }
}

async function getArticleList(
    lang: string,
    catslug: string,
    limit: number,
    offset: number,
): Promise<ArticleResponse[]> {
    const request = new RequestModel();
    request.lang = lang;
    request.limit = limit;
    request.offset = offset;
    request.slug = await checkForDecode(catslug);
    const response = await apiCalls(
        request,
        EndPointPaths.getarticlesbycategoryslug,
    );
    if (response.status === 0 && response.data.statusCode === 0) {
        return response.data.respList || [];
    }
    return [];
}
async function getSubCategories(
    lang: string,
    catslug: string,
): Promise<SubCategoryResponse[]> {
    const request = new RequestModel();
    request.lang = lang;
    request.extraVariable = "article";
    request.slug = await checkForDecode(catslug);
    const response = await apiCalls(
        request,
        EndPointPaths.getallsubcategorybycategoryslugtopic,
    );
    if (response.status === 0 && response.data.statusCode === 0) {
        return response.data.respList || [];
    }
    return [];
}
const langPrefix = await getLangPrefix(lang);
const apiServer = await getAppConfig();
const baseUrl = await buildLangUrl(lang);
const siteName = metaConfig.siteName[lang];
const jsonLd = [];
let categoryObj: CategoryResponse = await loadContent(
    "category",
    catslug,
    lang,
);
if (!categoryObj) {
    categoryObj = await getCategory(lang, catslug);
    if (!categoryObj) {
        return new Response("Category not found", { status: 404 });
    }
}
const subCatList: Array<SubCategoryResponse> = await getSubCategories(
    lang,
    catslug,
);
const articles: Array<ArticleResponse> = await getArticleList(
    lang,
    catslug,
    limit,
    offset,
);
let canonicalUrl: string = null;
if (!!categoryObj) {
    canonicalUrl =
        currentPage === 1
            ? `${baseUrl}category/${categoryObj.slug}`
            : `${baseUrl}category/${categoryObj.slug}?page=${currentPage}`;
    const breadCrumb = generateBreadcrumb("Home Page Breadcrumbs", [
        {
            name: lang === "ar" ? "الرئيسية" : "Home",
            url: baseUrl,
        },
        {
            name: lang === "ar" ? "فئة" : "Category",
            url: baseUrl + "category/",
        },
        {
            name: categoryObj.title,
            url: baseUrl + "category/" + catslug,
        },
    ]);
    jsonLd.push(breadCrumb);
}
if (articles) {
    const itemListJson = generateItemList({
        name: categoryObj.title + " Article Collection",
        description:
            "Explore our collection of in-depth articles covering culture, trends, lifestyle, creativity, and modern storytelling. Updated regularly with fresh insights",
        baseUrl: baseUrl + "article/",
        listUrl: baseUrl + "article/",
        items: articles.map((a: ArticleResponse) => ({
            title: a.title,
            slug: a.slug,
            image: a.landScapeBanner,
            authorName: a.authorName,
            authorSlug: a.authorSlug,
            type: "Article",
        })),
        creatorName: siteName,
        creatorUrl: apiServer.websiteUrl,
    });
    jsonLd.push(itemListJson);
}
if (subCatList) {
    const itemListJson = generateItemList({
        name: categoryObj.title + " Sub Category Collection",
        description:
            "Explore in-depth articles on culture, trends, lifestyle, creativity, and modern storytelling—fresh insights and inspiration, updated regularly.",
        baseUrl: baseUrl + "category/" + categoryObj.slug,
        listUrl: baseUrl + "category/" + categoryObj.slug,
        items: subCatList.map((a: SubCategoryResponse) => ({
            title: a.title,
            slug: "category/" + categoryObj.slug + "/" + a.slug,
            image: a.bannerImage,
            type: "Category",
        })),
        creatorName: siteName,
        creatorUrl: apiServer.websiteUrl,
    });
    jsonLd.push(itemListJson);
}
const isPageOne = currentPage === 1;

const pageLabel =
  lang === "ar" ? `الصفحة ${currentPage}` : `Page ${currentPage}`;

const title = isPageOne
  ? categoryObj.metaTitle
  : `${categoryObj.metaTitle} – ${pageLabel}`;

const description = isPageOne
  ? categoryObj.metaDescription
  : lang === "ar"
      ? `${categoryObj.metaDescription} تصفح ${pageLabel}.`
      : `${categoryObj.metaDescription} Browse ${pageLabel}.`;

const ua = Astro.request.headers.get("user-agent");
const device = detectDevice(ua);
const language: any = lang;
let metaObj: MetaObject = generateSeo(
    title,
    description,
    language,
    device,
);
---
{
    categoryObj && (
        <SEO
             title={metaObj.title}
    description={metaObj.metaDesc}
            image={categoryObj.bannerImage}
            url={canonicalUrl}
            lang={lang}
            canonical={canonicalUrl}
            noindex={false}
            type={"WebSite"}
            jsonLd={jsonLd}
        />
    )
}
<Layout>
    <main>
        <!-- HERO BANNER -->
        <section class="category-hero">
            <div
                class="category-hero-bg"
                style={`background-image: url('${categoryObj.bannerImage}')`}
            >
            </div>

            <div class="category-hero-content">
                <h1 class="category-title">{categoryObj.title}</h1>

                <p class="category-description">
                    {categoryObj.description}
                </p>

                <!-- Subcategories -->
                <div class="subcat-wrapper">
                    {
                        subCatList?.length > 0
                            ? subCatList.map((item) => (
                                  <a
                                      href={`/${langPrefix}category/${categoryObj.slug}/${item.slug}`}
                                      class="subcat-pill"
                                  >
                                      {item.title}
                                  </a>
                              ))
                            : null
                    }
                </div>
            </div>

            <div class="category-wave"></div>
        </section>
        <section>
			 <div id="container-7538bd9c37b3bc6235c127a4b18d2e6c"></div>
		</section>
        <!-- ARTICLES -->
        {
            articles ? (
                <section class="articles-grid">
                    {articles.length ? (
                        articles.map((item) => (
                            <article class="article-card">
                                <a
                                    href={`/${langPrefix}article/${item.slug}`}
                                    class="card-link"
                                >
                                    <div class="card-image">
                                        <Image
                                            src={item.landScapeBanner}
                                            alt={item.imageAlt || item.title}
                                            loading="lazy"
                                            width="400"
                                            height="225"
                                        />
                                    </div>

                                    <div class="card-content">
                                        <h2>{item.title}</h2>
                                    </div>
                                </a>
                            </article>
                        ))
                    ) : (
                        <p class="no-articles">
                            {lang === "ar"
                                ? "لا توجد مقالات."
                                : "No articles available."}
                        </p>
                    )}
                </section>
                <section>
                                <AdPlaceholder
                                    calledFrom="category"
                                    slot="2578599202"
                                    layout="display"
                                    format="auto"
                                    display="block"
                                    textAlign="center"
                                    height={200}
                                    width="100%"
                                />
                            </section>
                <nav class="pagination">
    {currentPage > 1 && (
        <a
            href={`/${langPrefix}category/${categoryObj.slug}?page=${currentPage - 1}`}
            rel="prev"
            class="pagination-btn"
        >
            ← {lang === "ar" ? "السابق" : "Previous"}
        </a>
    )}

    <span class="page-number">
        {lang === "ar"
            ? `صفحة ${currentPage}`
            : `Page ${currentPage}`}
    </span>

    {articles.length === limit && (
        <a
            href={`/${langPrefix}category/${categoryObj.slug}?page=${currentPage + 1}`}
            rel="next"
            class="pagination-btn"
        >
            {lang === "ar" ? "التالي" : "Next"} →
        </a>
    )}
</nav>
            ) : null
        }
    </main>

    <!-- PAGE CSS -->
    <style>
        
        /* ================================
       Pagination
    ================================ */
.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1.5rem;
    margin: 3rem 0;
}

.pagination-btn {
    padding: 0.6rem 1.4rem;
    border-radius: 9999px;
    text-decoration: none;
    font-weight: 600;
    border: 1px solid;
}

.page-number {
    font-weight: 700;
}
        /* ================================
       HERO
    ================================ */
     .category-hero {
    position: relative;
    min-height: 75vh;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    border-radius: 10px;
    overflow: hidden;
}

        .category-hero-bg {
    position: absolute;
    inset: 0;
    background-size: cover;
    background-position: center;
    z-index: 0;
}

/* Dark gradient overlay */
.category-hero-bg::after {
    content: "";
    position: absolute;
    inset: 0;
    background: linear-gradient(
        to bottom,
        rgba(0, 0, 0, 0.55),
        rgba(0, 0, 0, 0.75)
    );
}

     .category-hero-content {
    position: relative;
    z-index: 2;
    max-width: 1000px;
    padding: 3rem 2rem;
    color: #fff;
}

      .category-title {
    font-size: clamp(2.8rem, 6vw, 4.8rem);
    font-weight: 900;
    line-height: 1.1;
    margin-bottom: 1.5rem;
    letter-spacing: -0.03em;
    text-shadow: 0 6px 20px rgba(0, 0, 0, 0.5);
}

       .category-description {
    font-size: clamp(1.15rem, 2.5vw, 1.5rem);
    line-height: 1.75;
    max-width: 720px;
    margin: 0 auto 2.5rem;
    color: rgba(255, 255, 255, 0.92);
    text-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
}

        /* ================================
       SUBCATEGORY PILLS
    ================================ */
        .subcat-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            margin-top: 2.5rem;
            padding: 0 1rem;
        }

       .subcat-pill {
    display: inline-flex;
    align-items: center;
    padding: 0.7rem 1.6rem;
    border-radius: 9999px;
    font-size: 1rem;
    font-weight: 600;
    text-decoration: none;
    color: #fff;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(6px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    transition: all 0.3s ease;
}

.subcat-pill:hover {
    background: rgba(255, 255, 255, 0.28);
    transform: translateY(-3px);
}

        /* ================================
       HERO WAVE
    ================================ */
        .category-wave {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 120px;
            clip-path: ellipse(150% 100% at 50% 100%);
        }

        /* ================================
       ARTICLES GRID
    ================================ */
        .articles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            padding: 16px;
        }

        .article-card {
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .article-card:hover {
            transform: translateY(-6px);
        }

        .card-link {
            display: block;
            text-decoration: none;
            color: inherit;
        }

        .card-image {
            position: relative;
            padding-top: 56.25%;
            overflow: hidden;
        }

        .card-image img {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .article-card:hover img {
            transform: scale(1.05);
        }

        .card-content {
            padding: 12px 16px;
        }

        .card-content h2 {
            font-size: 18px;
            margin: 0;
            line-height: 1.3;
        }

        .no-articles {
            text-align: center;
            font-size: 16px;
            padding: 20px;
        }

        /* ================================
       RTL
    ================================ */
        html[lang="ar"] .card-content h2,
        html[lang="ar"] .category-description {
            text-align: right;
        }
    </style>
</Layout>
