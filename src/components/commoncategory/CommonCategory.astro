---
import {
    apiCalls,
    buildLangUrl,
    generateBreadcrumb,
    generateItemList,
} from "@lib/postmethodService";
import { EndPointPaths } from "@lib/EndPointPaths";
import { RequestModel } from "@lib/pojo/requestmodel/RequestModel";
import { ArticleResponse } from "@lib/pojo/responsemodel/ArticleResponse";
import Layout from "@layouts/Layout.astro";
import SEO from "@components/SEO.astro";
import { metaConfig } from "@components/metaConfig";
import { getAppConfig } from "@lib/AppConfig";
import { checkForDecode } from "@lib/postmethodService";
import { ApiResponse } from "@lib/pojo/responsemodel/ApiResponse";
import { ResponseModel } from "@lib/pojo/responsemodel/ResponseModel";
import { getLangPrefix } from "@lib/postmethodService";
import type { CatResponse } from "@lib/pojo/responsemodel/CatResponse";
import type { CategoryResponse } from "@lib/pojo/responsemodel/CategoryResponse";
import type { SubCategoryResponse } from "@lib/pojo/responsemodel/SubCategoryResponse";

interface Props {
    catslug: string;
    lang: string;
}
const { catslug = "", lang = "ar" } = Astro.props;
// const lang = Astro.url.pathname.startsWith("/en") ? "en" : "ar";
// Fetch homepage data or articles specific to home page

const categoryCache: Map<string, CatResponse[]> = new Map();

async function getCategory(
    lang: string,
    catslug: string,
): Promise<CategoryResponse | null> {
    const request = new RequestModel();
    request.lang = lang;
    request.slug = await checkForDecode(catslug);
    try {
        const response: ApiResponse = await apiCalls(
            request,
            EndPointPaths.getcategorybyslug,
        );
        if (response.status !== 0) return null;
        const resp: ResponseModel = response.data;
        return resp.statusCode === 0 ? resp.respObject : null;
    } catch (error) {
        console.error("Error fetching category:", error);
        return null;
    }
}

async function getArticleList(
    lang: string,
    catslug: string,
): Promise<ArticleResponse[]> {
    const request = new RequestModel();
    request.lang = lang;
    request.limit = 5;
    request.offset = 0;
    request.slug = await checkForDecode(catslug);
    const response = await apiCalls(
        request,
        EndPointPaths.getarticlesbycategoryslug,
    );
    if (response.status === 0 && response.data.statusCode === 0) {
        return response.data.respList || [];
    }
    return [];
}
async function getSubCategories(
    lang: string,
    catslug: string,
): Promise<SubCategoryResponse[]> {
    const request = new RequestModel();
    request.lang = lang;
    request.extraVariable = "article";
    request.slug = await checkForDecode(catslug);
    const response = await apiCalls(
        request,
        EndPointPaths.getallsubcategorybycategoryslugtopic,
    );
    if (response.status === 0 && response.data.statusCode === 0) {
        return response.data.respList || [];
    }
    return [];
}
const langPrefix = getLangPrefix(lang);
const apiServer = getAppConfig();
const baseUrl = await buildLangUrl(lang);
const siteName = metaConfig.siteName[lang];
const jsonLd = [];

const categoryObj: CategoryResponse = await getCategory(lang, catslug);
const subCatList: Array<SubCategoryResponse> = await getSubCategories(
    lang,
    catslug,
);
const articles: Array<ArticleResponse> = await getArticleList(lang, catslug);
let canonicalUrl: string = null;
if (!!categoryObj) {
    canonicalUrl = baseUrl + "category/" + categoryObj.slug;
    const breadCrumb = generateBreadcrumb("Home Page Breadcrumbs", [
        {
            name: lang === "ar" ? "الرئيسية" : "Home",
            url: baseUrl,
        },
        {
            name: lang === "ar" ? "فئة" : "Category",
            url: baseUrl + "category/",
        },
        {
            name: categoryObj.title,
            url: baseUrl + "category/" + catslug,
        },
    ]);
    jsonLd.push(breadCrumb);
}
if (articles) {
    const itemListJson = generateItemList({
        name: categoryObj.title + " Article Collection",
        description:
            "Explore our collection of in-depth articles covering culture, trends, lifestyle, creativity, and modern storytelling. Updated regularly with fresh insights",
        baseUrl: baseUrl + "article/",
        listUrl: baseUrl + "article/",
        items: articles.map((a: ArticleResponse) => ({
            title: a.title,
            slug: a.slug,
            image: a.landScapeBanner,
            authorName: a.authorName,
            authorSlug: a.authorSlug,
            type: "Article",
        })),
        creatorName: siteName,
        creatorUrl: apiServer.websiteUrl,
    });
    jsonLd.push(itemListJson);
}
if (subCatList) {
    const itemListJson = generateItemList({
        name: categoryObj.title + " Sub Category Collection",
        description:
            "Explore in-depth articles on culture, trends, lifestyle, creativity, and modern storytelling—fresh insights and inspiration, updated regularly.",
        baseUrl: baseUrl + "category/" + categoryObj.slug,
        listUrl: baseUrl + "category/" + categoryObj.slug,
        items: subCatList.map((a: SubCategoryResponse) => ({
            title: a.title,
            slug: "category/" + categoryObj.slug + "/" + a.slug,
            image: a.bannerImage,
            type: "Category",
        })),
        creatorName: siteName,
        creatorUrl: apiServer.websiteUrl,
    });
    jsonLd.push(itemListJson);
}
---

{
    categoryObj && (
        <SEO
            title={categoryObj.metaTitle}
            description={categoryObj.metaDescription}
            image={categoryObj.bannerImage}
            url={canonicalUrl}
            lang={lang}
            canonical={canonicalUrl}
            noindex={false}
            type={"WebSite"}
            jsonLd={jsonLd}
        />
    )
}
<Layout>
    <main>
        <!-- HERO BANNER -->
        <section class="category-hero">
            
            <div
                class="category-hero-bg"
                style={`background-image: url('${categoryObj.bannerImage}')`}
            >
            </div>

            <div class="category-hero-content">
                <h1 class="category-title">{categoryObj.title}</h1>

                <p class="category-description">
                    {categoryObj.description}
                </p>

                <!-- Subcategories -->
                <div class="subcat-wrapper">
                    {
                        subCatList?.length > 0
                            ? subCatList.map((item) => (
                                  <a
                                      href={`/${langPrefix}category/${categoryObj.slug}/${item.slug}`}
                                      class="subcat-pill"
                                  >
                                      {item.title}
                                  </a>
                              ))
                            : null
                    }
                </div>
            </div>

            <div class="category-wave"></div>
        </section>

        <!-- ARTICLES -->
        {
            articles ? (
                <section class="articles-grid">
                    {articles.length ? (
                        articles.map((item) => (
                            <article class="article-card">
                                <a
                                    href={`/${langPrefix}article/${item.slug}`}
                                    class="card-link"
                                >
                                    <div class="card-image">
                                        <img
                                            src={item.landScapeBanner}
                                            alt={item.imageAlt || item.title}
                                            loading="lazy"
                                            width="400"
                                            height="225"
                                        />
                                    </div>

                                    <div class="card-content">
                                        <h2>{item.title}</h2>
                                    </div>
                                </a>
                            </article>
                        ))
                    ) : (
                        <p class="no-articles">
                            {lang === "ar"
                                ? "لا توجد مقالات."
                                : "No articles available."}
                        </p>
                    )}
                </section>
            ) : null
        }
    </main>

    <!-- PAGE CSS -->
    <style>
        /* ================================
       HERO
    ================================ */
        .category-hero {
            position: relative;
            min-height: 70vh;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            overflow: hidden;
        }

        .category-hero-bg {
            position: absolute;
            inset: 0;
            background-image: var(--hero-bg);
            background-size: cover;
            background-position: center;
            z-index: 0;
            aspect-ratio: 5 / 3; /* ✅ keeps rectangle on mobile */
        }

        .category-hero-content {
            position: relative;
            z-index: 1;
            max-width: 900px;
            padding: 2rem;
        }

        .category-title {
            font-size: clamp(2.5rem, 6vw, 4.5rem);
            font-weight: 900;
            line-height: 1.1;
            margin-bottom: 1.5rem;
            letter-spacing: -1px;
        }

        .category-description {
            font-size: clamp(1.1rem, 2.5vw, 1.5rem);
            max-width: 700px;
            margin: 0 auto 2.5rem;
            line-height: 1.7;
            font-weight: 300;
        }

        /* ================================
       SUBCATEGORY PILLS
    ================================ */
        .subcat-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            margin-top: 2.5rem;
            padding: 0 1rem;
        }

        .subcat-pill {
            display: inline-flex;
            align-items: center;
            padding: 0.85rem 1.8rem;
            border-radius: 9999px;
            font-size: 1.05rem;
            font-weight: 600;
            text-decoration: none;
            border: 1.5px solid;
            transition: transform 0.3s ease;
        }

        .subcat-pill:hover {
            transform: translateY(-4px) scale(1.05);
        }

        /* ================================
       HERO WAVE
    ================================ */
        .category-wave {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 120px;
            clip-path: ellipse(150% 100% at 50% 100%);
        }

        /* ================================
       ARTICLES GRID
    ================================ */
        .articles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            padding: 16px;
        }

        .article-card {
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .article-card:hover {
            transform: translateY(-6px);
        }

        .card-link {
            display: block;
            text-decoration: none;
            color: inherit;
        }

        .card-image {
            position: relative;
            padding-top: 56.25%;
            overflow: hidden;
        }

        .card-image img {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .article-card:hover img {
            transform: scale(1.05);
        }

        .card-content {
            padding: 12px 16px;
        }

        .card-content h2 {
            font-size: 18px;
            margin: 0;
            line-height: 1.3;
        }

        .no-articles {
            text-align: center;
            font-size: 16px;
            padding: 20px;
        }

        /* ================================
       RTL
    ================================ */
        html[lang="ar"] .card-content h2,
        html[lang="ar"] .category-description {
            text-align: right;
        }
    </style>
</Layout>
