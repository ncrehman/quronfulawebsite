---
import type { QuizStoryResponse } from "@lib/pojo/responsemodel/QuizStoryResponse";
import QuizAmpRenderer from "@components/commonquiz/QuizAmpRenderer.ts";
import { EndPointPaths } from "@lib/EndPointPaths";
import { RequestModel } from "@lib/pojo/requestmodel/RequestModel";
import type { ApiResponse } from "@lib/pojo/responsemodel/ApiResponse";
import type { ResponseModel } from "@lib/pojo/responsemodel/ResponseModel";
import { checkForDecode, apiCalls } from "@lib/postmethodService";
import { loadContent } from "@lib/contentLoader";
import { getLangFromPath } from "@lib/postmethodService";

const { slug } = Astro.params;
const currentPath = Astro.url.pathname;
const lang = getLangFromPath(currentPath);

if (!slug) {
  return new Response("Not Found", { status: 404 });
}

export async function getQuizStory(
  lang: string,
  slug: string | undefined,
): Promise<QuizStoryResponse | null> {
  if (!slug) return null;
  try {
    const request = new RequestModel();
    request.lang = lang;
    request.slug = await checkForDecode(slug);
    const responseResult: ApiResponse = await apiCalls(
      request,
      EndPointPaths.getquizbyslug,
    );
    if (responseResult.status === 0) {
      const response: ResponseModel = responseResult.data;
      if (response.statusCode === 0) {
        return response.respObject as QuizStoryResponse;
      }
    }
  } catch (err) {
    console.error("getQuizStory error:", err);
  }
  return null;
}
let quiz: QuizStoryResponse = await loadContent("quiz", slug, lang);
if (!quiz) {
  quiz = await getQuizStory(lang, slug);
  if (!quiz) {
    return new Response("Quiz not found", { status: 404 });
  }
}
const response = await QuizAmpRenderer({ quiz, lang });
return response;
---
